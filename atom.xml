<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>个人随想</title>
  
  <subtitle>fly97&#39;s Blogs</subtitle>
  <link href="https://fly97.cn/atom.xml" rel="self"/>
  
  <link href="https://fly97.cn/"/>
  <updated>2023-02-04T02:03:00.000Z</updated>
  <id>https://fly97.cn/</id>
  
  <author>
    <name>fly97</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Scaleway星辰Stardust纯IPv6服务器体验</title>
    <link href="https://fly97.cn/p/stardust-VPS-in-scalway/"/>
    <id>https://fly97.cn/p/stardust-VPS-in-scalway/</id>
    <published>2023-02-04T02:03:00.000Z</published>
    <updated>2023-02-04T02:03:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>Stardust是法国云服务器厂商Scaleway下的一款的经济实例。官方介绍是这样的——“Atiny Instance so powerful and cost effective that we only release itonce a month.”</p><p>Stardust可以使用大小为5G的免费硬盘，并带有免费的IPv6地址，因此为了减免费用可以将收费提供的IPv4地址关掉，这样就可以免费使用流量了。</p><p>本文主要介绍如何开通Scaleway星辰Stardust服务器，并对其进行一些配置，以便其可以正常使用。</p><p>关键词：<strong>Stardust</strong></p><span id="more"></span><h2 id="开通">开通</h2><p>注册地址：<ahref="https://console.scaleway.com/">https://console.scaleway.com/</a></p><p>Stardust服务器仅仅在以下地区提供：</p><p><img data-src="image-20230204184827546.png" /></p><p>由于是限量供应，因此网站常常显示已售罄。</p><figure><img data-src="image-20230204184955458.png" alt="image-20230204184955458" /><figcaption aria-hidden="true">image-20230204184955458</figcaption></figure><p>可以通过API进行开通，进而绕过此限制。</p><h3 id="安装api">安装API</h3><p>下载地址：<ahref="https://github.com/scaleway/scaleway-cli">https://github.com/scaleway/scaleway-cli</a></p><p>安装完毕以后需要创建一个token：<ahref="https://console.scaleway.com/project/credentials">https://console.scaleway.com/project/credentials</a>，创建完了以后如下图所示，需要记录<strong>SecretKey</strong>，该值显示一次。</p><p><img data-src="image-20230204185843449.png" /></p><p>在cmd或者shell控制台输入<code>scw init</code>，根据提示输入上文记录的SecretKey.</p><p><img data-src="image-20230204190323811.png" /></p><h3 id="使用api创建机器">使用API创建机器</h3><p>Github的readme提供了很详细的使用说明：<ahref="https://github.com/scaleway/scaleway-cli#reference-documentation">https://github.com/scaleway/scaleway-cli#reference-documentation</a></p><figure><img data-src="image-20230204190729175.png" alt="image-20230204190729175" /><figcaption aria-hidden="true">image-20230204190729175</figcaption></figure><p>我们这里需要使用的是<code>instance CLI</code>，点击CLI并选择<code>Ceate server</code>.</p><figure><img data-src="image-20230204190904436.png" alt="image-20230204190904436" /><figcaption aria-hidden="true">image-20230204190904436</figcaption></figure><p>根据下面表格中列的信息，设置输入的参数</p><figure><img data-src="image-20230204202125963.png" alt="image-20230204202125963" /><figcaption aria-hidden="true">image-20230204202125963</figcaption></figure><p>主要有以下几个参数需要设置</p><p>image：服务器镜像，这里使用debian_bullseye, 也可以使用其他</p><p>type：服务器类型， 这里使用STARDUST1-S</p><p>ip：这里使用none，即不创建IPv4地址</p><p>ipv6：这里使用true，创建ipv6地址</p><p>zone：地区，默认地区是法国</p><p>组合以上参数，在控制台执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scw instance server create image=debian_bullseye <span class="built_in">type</span>=STARDUST1-S ip=none ipv6=<span class="literal">true</span></span><br></pre></td></tr></table></figure><figure><img data-src="image-20230204203837121.png" alt="image-20230204203837121" /><figcaption aria-hidden="true">image-20230204203837121</figcaption></figure><p>说明以及创建成功。</p><p>登录后台，查看运行的机器。登录到后台以后发现无法开机器，后来才发现是创建机器的时候没有声明根存储，最小是10G.</p><figure><img data-src="image-20230204204234274.png" alt="image-20230204204234274" /><figcaption aria-hidden="true">image-20230204204234274</figcaption></figure><p>重新执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scw instance server create image=debian_bullseye <span class="built_in">type</span>=STARDUST1-S ip=none ipv6=<span class="literal">true</span> root-volume=b:10G</span><br></pre></td></tr></table></figure><p>还是无法开机。说明当前地域资源已用尽。于是切换到另外一个荷兰地区。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scw instance server create image=debian_bullseye <span class="built_in">type</span>=STARDUST1-S ip=none ipv6=<span class="literal">true</span> root-volume=b:10G zone=nl-ams-1</span><br></pre></td></tr></table></figure><p>创建成功啦！</p><figure><img data-src="image-20230204205112843.png" alt="image-20230204205112843" /><figcaption aria-hidden="true">image-20230204205112843</figcaption></figure><h2 id="设置机器">设置机器</h2><p>注意：需要使用IPv6地址连接。</p><figure><img data-src="image-20230204205425980.png" alt="image-20230204205425980" /><figcaption aria-hidden="true">image-20230204205425980</figcaption></figure><h3 id="访问ipv4网络">访问IPv4网络</h3><p>由于常见的网络地址都是IPv4地址，因此需要赋予机器访问IPv4地址的能力。这里有两种方案。</p><h4 id="dns64和nat64">DNS64和NAT64</h4><p>使用DNS64和NAT64技术，具体可以参考这一篇文章：<ahref="https://developers.google.com/speed/public-dns/docs/dns64?hl=zh-cn">Google公共 DNS64 | Public DNS | Google Developers</a></p><p>简单说就是请求DNS时，将IPv4地址嵌入在IPv6地址里，此时需要有一个支持DNS64服务的DNS。因此只需要将DNS地址更改为支持DNS64服务的地址，就可以实现访问IPv4的网站。</p><p>经过我的测试，谷歌的DNS64dns在这一款服务器上无法使用，可能是和网络有关。给出几个可以使用的DNS64服务的地址。</p><table><colgroup><col style="width: 17%" /><col style="width: 20%" /><col style="width: 27%" /><col style="width: 34%" /></colgroup><thead><tr class="header"><th>提供商</th><th>国家/城市</th><th>DNS64服务</th><th>NAT64前缀</th></tr></thead><tbody><tr class="odd"><td>Kasper Dupont</td><td>德国/纽伦堡</td><td>2a01:4f8:c2c:123f::1</td><td>2a01:4f8:c2c:123f:64::/96</td></tr><tr class="even"><td>Kasper Dupont</td><td>英国/伦敦</td><td>2a00:1098:2c::1</td><td>2a00:1098:2c::/96</td></tr><tr class="odd"><td>Kasper Dupont</td><td>荷兰/阿姆斯特丹</td><td>2a00:1098:2b::1</td><td>2a00:1098:2b::/96</td></tr></tbody></table><p>将DNS更改为以上的DNS服务即可。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/resolv.conf </span><br><span class="line"><span class="comment">## nameserver 2a00:1098:2b::1</span></span><br></pre></td></tr></table></figure><p>设置完毕以后发现可以访问github.com了。</p><p><img data-src="image-20230205141017958.png" /></p><p>但是这种方式也有一定的问题，就是无法访问纯ipv4地址，下面来看第二种方案。</p><h4 id="cloudflare-warp">Cloudflare warp</h4><p>warp是Cloudflare基于wireguard提供的一款免费软件，可以通过其经过ipv6地址访问ipv4的网站，也可以访问纯ipv4的地址。</p><p>可以使用一键脚本，已经开源在GitHub上：<ahref="https://github.com/fscarmen/warp">fscarmen/warp: WARP one-clickscript. Add an IPv4, IPv6 or dual-stack CloudFlare WARP networkinterface and Socks5 proxy for VPS. 一键脚本 (github.com)</a></p><p>根据脚本的提示操作即可。</p><p><img data-src="image-20230205152823725.png" /></p><p>实测这种方式最方便。</p><h2 id="性能测试">性能测试</h2><p>安装经典的<code>bench.ch</code>脚本测试以下服务器的性能</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -qO- bench.sh | bash</span><br></pre></td></tr></table></figure><figure><img data-src="image-20230205153728307.png" alt="image-20230205153728307" /><figcaption aria-hidden="true">image-20230205153728307</figcaption></figure><p>相比于<strong>国内某些厂商</strong>提供的服务器，性能还是非常不错的。</p><h2 id="账单">账单</h2><p>这款机器如果只开IPv6，系统盘设置为最小10G，则每个月只需要不到0.5欧元。还不到人民币五块钱。如果你那里IPv6连接比较好，可以试试这一款服务器。</p><p><img data-src="image-20230205154205719.png" /></p><p>全文完。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Stardust是法国云服务器厂商Scaleway下的一款的经济实例。官方介绍是这样的——“A
tiny Instance so powerful and cost effective that we only release it
once a month.”&lt;/p&gt;
&lt;p&gt;Stardust可以使用大小为5G的免费硬盘，并带有免费的IPv6地址，因此为了减免费用可以将收费提供的IPv4地址关掉，这样就可以免费使用流量了。&lt;/p&gt;
&lt;p&gt;本文主要介绍如何开通Scaleway星辰Stardust服务器，并对其进行一些配置，以便其可以正常使用。&lt;/p&gt;
&lt;p&gt;关键词：&lt;strong&gt;Stardust&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="golang" scheme="https://fly97.cn/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Go操作数据库(二)</title>
    <link href="https://fly97.cn/p/go-with-database-2/"/>
    <id>https://fly97.cn/p/go-with-database-2/</id>
    <published>2023-01-31T09:26:00.000Z</published>
    <updated>2023-01-31T09:26:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>MySQL是常用的关系数据库，本文主要介绍Go语言怎么操作MySQL数据库。</p><p>关键词：<strong>golang</strong></p><p>在项目中我们通常会使用<code>database/sql</code>连接MySQL数据库。本文结束<code>sqlx</code>实现批量插入数据的例子，介绍了<code>sqlx</code>中可能被忽略的<code>sqlx.In</code>和<code>DB.NameExec</code>方法。</p><span id="more"></span><h2 id="sqlx介绍">sqlx介绍</h2><p><code>sqlx</code>被分为是<code>database/sql</code>的超集，在<code>database/sql</code>的基础上提供了一组扩展，而这组扩展处理大家常用来查询的<code>Get(dest interface&#123;&#125;, ...) error</code>和<code>Select(dest interface&#123;&#125;, ...) error</code>之外，还有很多强大的功能。</p><p>仓库地址：<ahref="github.com/jmoiron/sqlx">github.com/jmoiron/sqlx</a></p><h2 id="安装">安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/jmoiron/sqlx</span><br></pre></td></tr></table></figure><h2 id="基本使用">基本使用</h2><h3 id="连接数据库">连接数据库</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> db *sqlx.DB</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initDB</span><span class="params">()</span></span> (err <span class="type">error</span>)&#123;</span><br><span class="line">    dsn := <span class="string">&quot;user:password@tcp(xxx.aws.us-west-1.rds.amazonaws.com:3306)/mt_subtitle_table?charset=utf8mb4&amp;parseTime=True&quot;</span></span><br><span class="line">    <span class="comment">//也可以使用MustConnect，连接不成功就panic</span></span><br><span class="line">    db, err = sqlx.Connect(<span class="string">&quot;mysql&quot;</span>, dsn)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;connect DB failed, err:%v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    db.SetMaxOpenConns(<span class="number">20</span>)              <span class="comment">// 设置最大连接数</span></span><br><span class="line">    db.SetMaxIdleConns(<span class="number">10</span>)   <span class="comment">// 设置最大闲置连接数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="查询">查询</h3><h4 id="查询单行数据">查询单行数据</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询单条数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">queryRowDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sqlStr := <span class="string">&quot;select id, actress, title from mt_subtitle_table where id = ?&quot;</span></span><br><span class="line">    <span class="keyword">var</span> m Moive</span><br><span class="line">    err := db.Get(&amp;m, sqlStr, <span class="string">&quot;AAA-001&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;get failed, err :%v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;m: %v&quot;</span>, m)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="查询多行数据">查询多行数据</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">queryMultRowDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sqlStr := <span class="string">&quot;select id, actress, title from mt_subtitle_table where actress= ?&quot;</span></span><br><span class="line">   <span class="keyword">var</span> movies []Movie</span><br><span class="line">    err := db.Select(&amp;moives, sqlStr, <span class="string">&quot;川岛芳子&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;query failed, err :%v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;movies: %#v&quot;</span>, movies)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="插入更新和删除">插入、更新和删除</h3><p>sqlx中的exec方法和原生sql中的exec使用基本一致：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//插入数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">insertRowDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sqlStr := <span class="string">&quot;insert into mt_subtitle_table(id, actress, title) values (?,?)&quot;</span></span><br><span class="line">    ret, err := db.Exec(sqlStr, <span class="string">&quot;AAA-002&quot;</span>, <span class="string">&quot;仲川そら&quot;</span>,<span class="string">&quot;赤面羞恥&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;insert failed, err:%v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    theID, err := ret.LastInsertId() <span class="comment">// 新插入数据的id</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;get lastinsert ID failed, err:%v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;insert success, the id is %d&quot;</span>, theID)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 更新数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">updateRowDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sqlStr := <span class="string">&quot;update mt_subtitle_table set actress=? where id = ?&quot;</span></span><br><span class="line">    ret, err := db.Exec(sqlStr, <span class="string">&quot;仲川そら&quot;</span>, <span class="string">&quot;マジックミラ&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;update failed, err:%v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    n, err := ret.RowAffected() <span class="comment">// 影响操作的行数</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;get RowAffected failed, err:%v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;update success, affected rows:%d&quot;</span>, n)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 删除数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deleteRowDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sqlStr := <span class="string">&quot;delete from mt_subtitle_table where id = ?&quot;</span></span><br><span class="line">    ret, err := db.Exec(sqlStr, <span class="string">&quot;AAA-002&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;delete failed, err:%v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    n, err := ret.RowsAffected() <span class="comment">// 影响操作的行数</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;get RowAffected failed, err:%v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;delete success, affected rows:%d&quot;</span>, n)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="namedexec">NamedExec</h3><p><code>DB.NamedExec</code>方法用来绑定SQL语句与<strong>结构体或者map中的同名字段</strong>。</p><p>map同名字段</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">insertUserDemo</span><span class="params">()</span></span> (err <span class="type">error</span>)  &#123;</span><br><span class="line">    sqlStr := <span class="string">&quot;INSERT INTO mt_subtitle_table(id, actress, title) values(:name, :age)&quot;</span></span><br><span class="line">    _, err = db.NamedExec(sqlStr,</span><br><span class="line">                          <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">                              <span class="string">&quot;id&quot;</span>: <span class="string">&quot;ABC-001&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;actress&quot;</span>: <span class="string">&quot;川岛芳子&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;title&quot;</span>: <span class="string">&quot;上海回忆录&quot;</span></span><br><span class="line">                          &#125;)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>:字段名</code>的用法要记住。</li></ul><p>结构体同名字段</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    FirstName <span class="type">string</span> <span class="string">`db:&quot;first_name&quot;`</span></span><br><span class="line">    LastName  <span class="type">string</span> <span class="string">`db:&quot;last_name&quot;`</span></span><br><span class="line">    Email     <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tx.NamedExec(<span class="string">&quot;INSERT INTO person (first_name, last_name, email) VALUES (:first_name, :last_name, :email)&quot;</span>, &amp;Person&#123;<span class="string">&quot;Jane&quot;</span>, <span class="string">&quot;Citizen&quot;</span>, <span class="string">&quot;jane.citzen@example.com&quot;</span>&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="namedquery">NamedQuery</h3><p>与<code>DB.NamedExec</code>同理，这里是支持查询</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">nameQuery</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sqlStr := <span class="string">&quot;SELECT * FROM mt_subtitle_table WHERE actress=:actress&quot;</span></span><br><span class="line">    <span class="comment">// 使用map做命名查询</span></span><br><span class="line">    rows, err := db.NamedQuery(sqlStr, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">        <span class="string">&quot;actress&quot;</span>: <span class="string">&quot;川岛芳子&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;dn.NamedQuery failed, err:%v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> rows.Close()</span><br><span class="line">    <span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">        <span class="keyword">var</span> m Movie</span><br><span class="line">        err := rows.StructScan(&amp;m)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;scan failed, err: %v&quot;</span>, err)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;movie: %v&quot;</span>, m)</span><br><span class="line">    &#125;</span><br><span class="line">    m1 := Movie&#123;</span><br><span class="line">        Id: <span class="string">&quot;SNAA-001&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 使用结构体命名查询，根据结构体的 db tag 进行映射</span></span><br><span class="line">    rows, err := db.NameQuery(sqlStr, m1)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;db.NamedQuery failed, err: %v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> rows.Close() </span><br><span class="line">    <span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">        <span class="keyword">var</span> m Moive</span><br><span class="line">        err != rows.StructScan(&amp;m)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;scan failed, err:%v&quot;</span>, err)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;movie: %#v&quot;</span>, m)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="事务操作">事务操作</h3><p>对于事务操作，我们可以使用<code>sqlx</code>中提供的<code>db.Beginx()</code>和<code>tx.Exec()</code>方法。<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">transationDemo</span><span class="params">()</span></span> (err <span class="type">error</span>) &#123;</span><br><span class="line">    tx. err := db.Begin() <span class="comment">// 开启事务</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Prinf(<span class="string">&quot;事务开始失败，错误:%v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// return之前执行</span></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> p := <span class="built_in">recover</span>(); p != <span class="literal">nil</span> &#123;</span><br><span class="line">            tx.Rollback()</span><br><span class="line">            <span class="built_in">panic</span>(p)      <span class="comment">// 回滚之后重新panic</span></span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">&quot;rollback&quot;</span>)</span><br><span class="line">            tx.Rollback() <span class="comment">// 有错误，因此需要回滚</span></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            err = tx.Commit() <span class="comment">// 没有错误，提交事务</span></span><br><span class="line">            fmt.Println(<span class="string">&quot;commit&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    </span><br><span class="line">    sqlStr1 := <span class="string">&quot;UPDATE mt_subtitle_table SET title=&#x27;艺妓回忆录&#x27; where id = ?&quot;</span></span><br><span class="line">    rs, err := tx.Exec(sqlStr1, <span class="string">&quot;ABC-001&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> n != <span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;sqlStr1执行失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    sqlStr2 := <span class="string">&quot;UPDATE mt_subtitle_table SET title=&#x27;上海回忆录&#x27; where id = ?&quot;</span></span><br><span class="line">    rs, err := tx.Exec(sqlStr2, <span class="string">&quot;AAA-001&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    n, err = rs.RowsAffected()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> n != <span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;sqlStr2执行失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="sqlx.in">sqlx.In</h2><p><code>sqlx.In</code>是<code>sqlx</code>提供的一个非常方便的函数。</p><h3 id="批量插入">批量插入</h3><p>这里创建一个表，表结构如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `mt_subtitle_table`  (</span><br><span class="line">  `id` text <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `actress` text <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `title` text <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">)ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure><p>定义一个结构体，字段通过tag和上述表中的字段一致。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Moive <span class="keyword">struct</span>&#123;</span><br><span class="line">    ID <span class="type">string</span> <span class="string">`db:&quot;id&quot;`</span></span><br><span class="line">    Actress <span class="type">string</span> <span class="string">`db:&quot;actress&quot;`</span></span><br><span class="line">    Title <span class="type">string</span> <span class="string">`db:&quot;title&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>绑定变量：bindvars</strong></p><p>查询占位符<code>?</code>又被称为<strong>bindvars</strong>，非常重要，应该<strong>始终使用它们向数据库发送值</strong>，因为他们可以防止SQL注入攻击。<code>database/sql</code>不尝试对查询文本进行任何验证；它与编码的参数一起按照原样发送到服务器，除非驱动程序实现一个特殊的接口，否则在执行之前，查询实在服务器上准备的。</p><p><code>bindvars</code>是特定于数据库的：</p><ul><li>MySQL中使用<code>?</code></li><li>PostgreSQL使用枚举的<code>$1</code>、<code>$2</code>等语法</li><li>SQLite中使用<code>?</code>和<code>$1</code>的语法都支持</li><li>Oracle中使用<code>:name</code>的语法</li></ul><p><code>bindvars</code>的一个常见错误是，他们用来在sql语句中插入值。其实他们<strong>仅仅用于参数化</strong>，不允许更改SQL语句的结构。例如使用<code>bindvars</code>尝试参数化列或表名将不起作用。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ? 不能用来插入表名（叫SQL语句中表名的占位符）</span></span><br><span class="line">db.Query(<span class="string">&quot;SELECT * FROM ?&quot;</span>, <span class="string">&quot;mytable&quot;</span>)</span><br><span class="line"><span class="comment">// ? 不能用来插入列名（叫做SQL语句中列名的占位符）</span></span><br><span class="line">db.Query(<span class="string">&quot;SELECT ?, ? FROM people&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;location&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="自己实现语句实现批量插入">自己实现语句实现批量插入</h4><p>比较笨，但是好理解。就是有多少个movie就拼接多少个<code>(?, ?)</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BatchInsertMoive 自行构造批量插入的语句</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BatchInsertMovie</span><span class="params">(movies []*Movie)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 存放(?, ?)的slice</span></span><br><span class="line">    valueStrings := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>, <span class="built_in">len</span>(movies))</span><br><span class="line">    <span class="comment">// 存放values的slice</span></span><br><span class="line">    valueArgs := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>, <span class="built_in">len</span>(movies) * <span class="number">3</span>)</span><br><span class="line">    <span class="comment">// 遍历users准备相关数据</span></span><br><span class="line">    <span class="keyword">for</span> _, m := <span class="keyword">range</span> moives &#123;</span><br><span class="line">        <span class="comment">// 此处占位符要与插入值的个数对应</span></span><br><span class="line">        valuesStrings = <span class="built_in">append</span>(valuesStrings, <span class="string">&quot;(?, ?, ?)&quot;</span>)</span><br><span class="line">        valueArgs = <span class="built_in">append</span>(valuesArgs, m.ID, m.Actress, m.Title)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 自行拼接要执行的具体语句</span></span><br><span class="line">    stmt := fmt.Sprintf(<span class="string">&quot;INSERT INTO mt_subtitle_table(id, actress, title) VALUES %s&quot;</span>,</span><br><span class="line">strings.Join(valueStrings, <span class="string">&quot;,&quot;</span>))</span><br><span class="line">    _, err := db.Exec(stmt, valueArgs...)</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="使用sqlx.in实现批量插入">使用sqlx.In实现批量插入</h4><p>前提是需要我们的结构体实现<code>driver.Valuer</code>接口</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Movie)</span></span> Value() (driver.Value, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> []<span class="keyword">interface</span>&#123;&#125;&#123;m.ID, m.Actress, m.title&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用<code>sqlx.In</code>实现批量插入代码如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//BatchInsertMoive 使用的是sqlx.In帮我们拼接语句和参数，注意传入的参数是[]interface&#123;&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BatchInsertMoive</span><span class="params">(moive []<span class="keyword">interface</span>&#123;&#125;)</span></span> (<span class="type">error</span>) &#123;</span><br><span class="line">    query, args, _ := sqlx.In(</span><br><span class="line">        <span class="string">&quot;INSERT INTO mt_subtitle_table(id, actress, title) VALUES (?), (?), (?),&quot;</span> <span class="comment">// 这里是根据movie长度来，还是根据字段的个数来，有待观察</span></span><br><span class="line">        movies..., <span class="comment">// 如果参数实现了driver.Valuer, sqlx.In会通过调用Value()来展开它</span></span><br><span class="line">    )</span><br><span class="line">    fmt.Println(query) <span class="comment">// 查看生成的querysting</span></span><br><span class="line">    fmt.Println(args) <span class="comment">// 查看生成的args</span></span><br><span class="line">    _, err := db.Exec(query, args...)</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="使用namedexec实现批量插入">使用NamedExec实现批量插入</h4><p>使用NamedExec实现批量插入的方法如下</p><p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BatchInsert</span><span class="params">(users []*User)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    _, err := db.NameExec(<span class="string">&quot;INSERT INTO mt_subtitle_table(id, actress, title) VALUES(:name, :age)&quot;</span>, users)</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="sqlx.in的查询例子">sqlx.In的查询例子</h3><p>关于<code>sqlx.In</code>这里在补充一个用法，在<code>sqlx</code>查询语句中实现了In查询和FIND_IN_SET函数。即实现<code>SELECT * FROM mt_subtitle_table WHERE actress in ("川岛芳子"，"广田雅美")</code>和<code>SELECT * FROM mt_subtitle_table in (3, 2, 1) ORDER BY FIND_IN_SET(id, "川岛芳子"，"广田雅美")</code>.</p><h4 id="in查询">in查询</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// QueryByIDs 根据指定ID查询</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">QueryByIDs</span><span class="params">(ids []<span class="type">string</span>)</span></span> (movies []Movie, err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 动态填充id</span></span><br><span class="line">    query, args, err := sqlx.In(<span class="string">&quot;SELECT id, actress, title FROM mt_subtitle_table WHERE actress IN (?)&quot;</span>, ids)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// sqlx.In返回带`?`bindvar`的查询语句，我们使用Rebind()重新绑定他</span></span><br><span class="line">    query = db.Rebind(query)</span><br><span class="line">    err = db.Select(&amp;movies, query, args...)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="in查询和find_in_set函数">in查询和FIND_IN_SET函数</h4><p>查询id在给定id集合的数据并维持给定id集合的顺序。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// QuertAndOrderByIDs 按照指定id查询并维护顺序</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">QuertAndOrderByIDs</span><span class="params">(ids []<span class="type">string</span>)</span></span>(moives []Movie, err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 动态填充id</span></span><br><span class="line">    strIDs := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>, <span class="built_in">len</span>(ids))</span><br><span class="line">    <span class="keyword">for</span> _, id := <span class="keyword">range</span> ids &#123;</span><br><span class="line">        strIDs = <span class="built_in">append</span>(strIDs, fmt.Sprintf(<span class="string">&quot;%d&quot;</span>, id))</span><br><span class="line">    &#125;</span><br><span class="line">    query, args, err := sqlx.In(<span class="string">&quot;SELECT id, actress FROM user WHERE id IN (?) ORDER BY FIND_IN_SET(id, ?) ORDER BY FIND_IN_SET(id, ?)&quot;</span>, ids, strings.Join(strIDs, <span class="string">&quot;,&quot;</span>))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// sqlx.In 返回带 `?` bindvar的查询语句，我们使用Rebind()重新绑定它</span></span><br><span class="line">    query = db.Rebind(query)</span><br><span class="line">    err = db.Select(&amp;movie, query, args...)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;MySQL是常用的关系数据库，本文主要介绍Go语言怎么操作MySQL数据库。&lt;/p&gt;
&lt;p&gt;关键词：&lt;strong&gt;golang&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;在项目中我们通常会使用&lt;code&gt;database/sql&lt;/code&gt;连接MySQL数据库。本文结束&lt;code&gt;sqlx&lt;/code&gt;实现批量插入数据的例子，介绍了&lt;code&gt;sqlx&lt;/code&gt;中可能被忽略的&lt;code&gt;sqlx.In&lt;/code&gt;和&lt;code&gt;DB.NameExec&lt;/code&gt;方法。&lt;/p&gt;</summary>
    
    
    
    
    <category term="golang" scheme="https://fly97.cn/tags/golang/"/>
    
    <category term="mysql在、" scheme="https://fly97.cn/tags/mysql%E5%9C%A8%E3%80%81/"/>
    
  </entry>
  
  <entry>
    <title>Go操作数据库(一)</title>
    <link href="https://fly97.cn/p/go-with-database-1/"/>
    <id>https://fly97.cn/p/go-with-database-1/</id>
    <published>2023-01-30T09:26:00.000Z</published>
    <updated>2023-01-30T09:26:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>MySQL是常用的关系数据库，本文主要介绍Go语言怎么操作MySQL数据库。</p><p>关键词：<strong>golang</strong></p><span id="more"></span><h2 id="连接">连接</h2><p>sql包提供了保证SQL或类SQL数据库的泛用接口。</p><p>使用sql包时必须注入（至少）一个数据库驱动。参见http://golang.org/s/sqldrivers获取驱动列表。</p><p>更多用法示例，参见wiki页面：http://golang.org/s/sqlwiki。</p><p>这里使用<code>github.com/go-sql-driver/mysql/</code>作为MySQL的驱动。</p><h4 id="下载依赖">下载依赖</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/go-sql-driver/mysql</span><br></pre></td></tr></table></figure><h4 id="初始化链接">初始化链接</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Open</span><span class="params">(driverName, dataSourceName <span class="type">string</span>)</span></span> (*DB, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><ul><li><p><strong>返回的DB类型可用被多个goroutine同时使用</strong>，只需要创建一次，很少需要关闭这个对象；</p></li><li><p>Open函数<strong>只验证</strong>参数格式是否正确，不创建数据库的连接，无法验证密码是否正确；</p></li><li><p>一般设置成全局变量，<strong>一次初始化然后整个模块使用</strong>。</p></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;database/sql&quot;</span></span><br><span class="line">    _ <span class="string">&quot;https://github.com/go-sql-driver/mysql&quot;</span> <span class="comment">// init mysql驱动</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">var</span> db *sql.DB</span><br><span class="line"><span class="comment">// Data Source Name</span></span><br><span class="line"><span class="keyword">const</span> dsn = <span class="string">&quot;root:xxx@tcp(127.0.0.1)/dbname&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line"><span class="comment">// Open不会校验账号密码是否正确</span></span><br><span class="line">    <span class="comment">// 这里不要使用:=, 我们是给全局变量赋值，然后在main函数中示意使用全局变量</span></span><br><span class="line">    db, err = sql.Open(<span class="string">&quot;mysql&quot;</span>, dsn)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> db.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="验证用户名和密码是否正确">验证用户名和密码是否正确</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Ping() <span class="type">error</span></span><br></pre></td></tr></table></figure><ul><li>验证数据库是否可用</li><li>如果必要的话建立一个连接</li></ul><h4 id="设置最大连接数">设置最大连接数</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> SetMaxOpenConns(n <span class="type">int</span>)</span><br></pre></td></tr></table></figure><ul><li>设置数据库最大连接数</li><li>如果n &gt;0且小于<strong>最大闲置连接数</strong>，则会将最大闲置连接数减少到匹配开启最大连接数的限制</li><li>如果n &lt;= 0（默认值），不会限制最大开启连接数限制</li></ul><h4 id="设置最大闲置连接数">设置最大闲置连接数</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> SetMaxIdleConns(n <span class="type">int</span>)</span><br></pre></td></tr></table></figure><ul><li>设置数据库最大闲置连接数</li><li>如果n大于<strong>最大连接数</strong>，则新的最大闲置连接数会减少到最大连接数</li><li>如果n &lt;= 0，则不会保持闲置连接，<strong>默认值为2</strong></li></ul><h2 id="增删改查">增删改查</h2><h3 id="建库建表">建库建表</h3><p>先在MySQL中创建一个名为movies的数据库</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE movies;</span><br></pre></td></tr></table></figure><p>进入该数据库：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">USE movies;</span><br></pre></td></tr></table></figure><p>创建一张用于测试的数据表：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `mt_subtitle_table`  (</span><br><span class="line">  `id` text NOT NULL,</span><br><span class="line">  `actress` text NOT NULL,</span><br><span class="line">  `title` text NOT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">)ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br></pre></td></tr></table></figure><p>为了方便查询，我们实现定义一个结构体来存储mt_subtitle_table表的数据。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Movie <span class="keyword">struct</span> &#123;</span><br><span class="line">    id <span class="type">string</span></span><br><span class="line">    actress <span class="type">string</span></span><br><span class="line">    title <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="单行查询">单行查询</h3><p>单行查询执行一次查询，并<strong>期望返回最多一行结果（即Row）</strong>。QueryRow总是返回非nil的值，直到返回值的Scan方法被调用时，才会返回被延迟的错误，如未找到结果等。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> QueryRow(query <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) *Row</span><br></pre></td></tr></table></figure><p>代码实例：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询单条数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">queryRowDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sqlStr := <span class="string">&quot;select id, actress, title from user where id=?&quot;</span></span><br><span class="line">    <span class="keyword">var</span> m Movie</span><br><span class="line">    <span class="comment">// 要确保QueryRow之后调用Scan方法，否则持有的数据库连接不会被释放。</span></span><br><span class="line">    err := db.QueryRow(sqlStr, <span class="string">&quot;APAA-401&quot;</span>).Scan(&amp;m.id, &amp;m.actress, &amp;m.title)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;scan failed, err: %v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;id: %s, actress: %s, title: %s&quot;</span>, m.id, m.actress, m.title)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="多行查询">多行查询</h3><p>多行查询<code>db.Query()</code>执行一次查询，返回多行结果（Rows），一般用于执行select命令，<strong>参数args表示query中的占位符参数</strong>。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Query(query <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)(*Rows, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>代码示例：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">queryMultRowDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sqlStr := <span class="string">&quot;select id, actress, title for user where actress = ?&quot;</span></span><br><span class="line">    rows, err := db.Query(sqlStr, <span class="string">&quot;樱空桃&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printlf(<span class="string">&quot;query failed, err: %v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 非常重要：释放持有的数据库连接</span></span><br><span class="line">    <span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">        <span class="keyword">var</span> m Moive</span><br><span class="line">        err := rows.Scan(&amp;m.id, &amp;m.actress, &amp;m.title)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;scan failed, err: %v&quot;</span>, err)</span><br><span class="line">            <span class="keyword">return</span> </span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;id: %s, actress: %s, title: %s&quot;</span>, m.id, m.name, m.age)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="插入数据">插入数据</h3><p>插入、更新和删除都使用<code>Exec</code>方法。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Exec(query <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) (Result, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>Exec执行一次命令（包括查询、删除、更新、插入等），返回的Result是对已执行的SQL命令的总结，参数args表示query中的占位参数。</p><p>插入数据代码示例：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 插入数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">insertRowDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sqlStr := <span class="string">&quot;insert into mt_subtitle_table(id, actress, title) values(?, ?, ?)&quot;</span></span><br><span class="line">    ret, err := db.Exec(sqlStr, <span class="string">&quot;APAA-401&quot;</span>, <span class="string">&quot;樱空桃&quot;</span>, <span class="string">&quot;先輩方の気遣いが嬉しい&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;insert failed, err :%v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    theID, err := ret.LastInsertId() <span class="comment">// 返回插入新数据的ID</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;get lastinsert ID failed, err: %v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;insert success, affected id: %v&quot;</span>, theID)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="更新数据">更新数据</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">updateRowDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sqlStr := <span class="string">&quot;update mt_subtitle_table set title=? where id=?&quot;</span></span><br><span class="line">    ret, err := db.Exec(sqlStr, <span class="string">&quot;先輩方の気遣いが嬉しい&quot;</span>, <span class="string">&quot;APAA-401&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;update failed, err: %v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    n, err := ret.RowsAffected() <span class="comment">// 返回操作影响的行数</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;get RowsAffected failed, err:%v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;update success, affected rows: %d\n&quot;</span>, n)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="删除数据">删除数据</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deleteRowDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sqlStr := <span class="string">&quot;delete from mt_subtitle_table where id = ?&quot;</span></span><br><span class="line">    ret, err := db.Exec(sqlStr, <span class="string">&quot;APAA-401&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;delete failed, err: %v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">    n, err := ret.RowAffected() <span class="comment">// 操作影响的行数</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;get RowsAffected failed, err: %v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;delete success, affected rows: %d&quot;</span>, n)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="mysql预处理">MySQL预处理</h2><h3 id="什么是预处理">什么是预处理</h3><p>普通SQL语句执行过程：</p><ol type="1"><li>客户端对SQL语句进行占位符替换得到完整的SQL语句；</li><li>客户端发送完整的SQL语句到MySQL服务端；</li><li>MySQL服务端执行完整的SQL语句并将结果返回给客户端。</li></ol><p>预处理执行过程：</p><ol type="1"><li>把SQL语句分成两部分，命令部分与数据部分。</li><li>先把命令部分发送到MySQL服务端，MySQL服务端进行SQL预处理。</li><li>然后把数据部分发送到MySQL服务端，MySQL服务端使用占位符进行替换。</li><li>MySQL服务端执行完整的SQL语句并将结果返回给客户端。</li></ol><h3 id="为何要预处理">为何要预处理</h3><ol type="1"><li>优化MySQL服务器重复执行SQL的方法，可以提升服务器性能，提前让服务器编译，一次编译多次执行，节省后续编译的成本。</li><li>避免SQL注入问题。</li></ol><h2 id="go实现mysql预处理">Go实现MySQL预处理</h2><p><code>database/sql</code>使用下面的<code>Prepare</code>方法来实现预处理操作。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Prepare(query <span class="type">string</span>)(*Stmt, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p><code>Prepare</code>方法会先将sql语句发送给MySQL服务端，返回一个准备好的状态用于之后的查询和命令。返回值可以同时执行多个查询和命令。</p><p>查询操作的预处理实例代码如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 预处理查询实例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prepareQueryDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sqlStr := <span class="string">&quot;select id, actress, title from mt_subtitle_table where actress = ?&quot;</span></span><br><span class="line">    stmt, err := db.Prepare(sqlStr)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;prepare failed, err: %v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> stmt.Close()</span><br><span class="line">    rows, err := stmt.Query(<span class="string">&quot;白桃花&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;query failed, err: %v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> rows.Close()</span><br><span class="line">    <span class="comment">// 循环读取结果中的数据</span></span><br><span class="line">    <span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">        <span class="keyword">var</span> m Movie</span><br><span class="line">        err := rows.Scan(&amp;m.id, &amp;m.actress, &amp;m.title)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;scan failed, err: %v&quot;</span>, err)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;id: %v, actress: %v, title: %v&quot;</span>, m.id, m.actress, m.title)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>插入、更新和删除的预处理操作十分类似，这里以插入数据的预处理为例：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 预处理插入实例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prepareInsertDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sqlStr := <span class="string">&quot;insert into mt_subtitle_table(id, actress, title) values(?,?)&quot;</span></span><br><span class="line">    stmt, err := db.Prepare(sqlStr)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;prepare failed, err:%v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> stmt.Close()</span><br><span class="line">    _, err = stmt.Exec(<span class="string">&quot;APAA-401&quot;</span>, <span class="string">&quot;白桃花&quot;</span>, <span class="string">&quot;先輩方の気遣いが嬉しい&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;insert failed, err:%v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    _, err = stmt.Exec(<span class="string">&quot;APAA-402&quot;</span>, <span class="string">&quot;樱空桃&quot;</span>, <span class="string">&quot;先輩方の気遣いが嬉しい&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;insert failed, err:%v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;insert success.&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="sql注入问题">SQL注入问题</h2><p>任何时候都不应该自己拼接SQL语句！</p><p>这里我们编写一个根据name字段查询user表的函数：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sql注入实例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sqlInjectDemo</span><span class="params">(name <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    sqlStr := fmt.Sprinf(<span class="string">&quot;select id, actress, title from mt_subtitle_table where actress = &#x27;%s&#x27;&quot;</span>, name)</span><br><span class="line">    <span class="keyword">var</span> m Movie</span><br><span class="line">    err := db.QueryRow(sqlStr).Scan(&amp;m.id, &amp;m.name, &amp;m.title)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;exec failed, err: %v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;movie: #%v\n&quot;</span>, m)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时输入以下字符串都可以引发SQL注入问题：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sqlInjectDemo(<span class="string">&quot;xxx&#x27; or 1=1#&quot;</span>)</span><br><span class="line">sqlInjectDemo(<span class="string">&quot;xxx&#x27; union select * from user #&quot;</span>)</span><br><span class="line">sqlInjectDemo(<span class="string">&quot;xxx&#x27; and (select count(*) from user) &gt; 10&quot;</span>)</span><br></pre></td></tr></table></figure><p>补充：不同的数据库中，SQL语句中使用的占位符语法不尽相同。</p><table><thead><tr class="header"><th>数据库</th><th>占位符</th></tr></thead><tbody><tr class="odd"><td>MySQL</td><td><code>?</code></td></tr><tr class="even"><td>PostgreSQL</td><td><code>$1</code>,<code>$2</code>等</td></tr><tr class="odd"><td>SQlite</td><td><code>?</code>和<code>$1</code></td></tr><tr class="even"><td>Oracle</td><td><code>:name</code></td></tr></tbody></table><h2 id="go实现mysql事务">Go实现MySQL事务</h2><h3 id="什么是事务">什么是事务</h3><p>事务：一个最小的不可再分的工作单元；</p><p>通常一个事务对应一个完整的业务（如银行转账业务，该业务就是一个最小的工作单元）同时这个完整的操作需要执行多次的DML（插入、更新、删除）语句共同联合完成，A转账给B，这里就需要两次update操作。</p><p>在MySQL中只有使用了Innodb数据库引擎的数据库才支持表或事物。事务处理可以用来维护数据的完整性，保证成批的SQL语句要么全部执行，要么全部不执行。</p><h3 id="事务的acid">事务的ACID</h3><p>通常事务必须满足四个条件（ACID）：原子性（Atomicity，或称不可分割性）、一致性（Consistency）、隔离性（Isolation又称独立性）、持久性（Durability）。</p><table><colgroup><col style="width: 9%" /><col style="width: 90%" /></colgroup><thead><tr class="header"><th>条件</th><th>解释</th></tr></thead><tbody><tr class="odd"><td>原子性</td><td>一个事务中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发送错误，会被回滚（Rollback）到事务前开始的状态，就像这个事务从来没有执行过一样。</td></tr><tr class="even"><td>一致性</td><td>在事务开始之前和事务结束以后，数据库的完整性没有被破坏，这表示写入的资料必须完全符合所有的预设规则，这包含资料的准确度、串联性以及后续数据库可以自发性的完成预定的工作。</td></tr><tr class="odd"><td>隔离性</td><td>数据库允许多个并发事务同时对其数据进行读写和修改的能力。隔离性可以防止多个事务并发执行时由于交叉执行而导致的数据行不一致的情况。事务隔离分为不同级别，包括读未提交（Readuncommitted）、读提交（Read committed)、可重复读（Repeatableread）和串行化（Serializable）。</td></tr><tr class="even"><td>持久性</td><td>事务处理结束以后，对数据的修改就是永久的，即便系统故障也不会丢失。</td></tr></tbody></table><h3 id="事务相关方法">事务相关方法</h3><p>Go语言使用以下三个方法实现MySQL中的事务操作。</p><p>开始事务</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Begin() (*Tx, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>提交事务</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tx *Tx)</span></span> Commit() <span class="type">error</span></span><br></pre></td></tr></table></figure><p>回滚事务</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tx *Tx)</span></span> Rollback() <span class="type">error</span></span><br></pre></td></tr></table></figure><h3 id="事务实例">事务实例</h3><p>下面的代码演示了一个简单的事务操作，该事务操作能够保证两次更新操作要么同时成功要么同时失败，不会出现中间状态。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 事务操作实例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">transationDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">    tx, err := db.Begin() <span class="comment">// 开启事务</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> tx != <span class="literal">nil</span> &#123;</span><br><span class="line">        tx.Rollback() <span class="comment">// 回滚</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;begin trans fail, err: %v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    sqlStr1 := <span class="string">&quot;UPDATE mt_subtitle_table set id = AAA501 where actress=?&quot;</span></span><br><span class="line">    ret1, err := tx.Exec(sqlStr1, <span class="string">&quot;若狭留美&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        tx.Rollback() <span class="comment">// 回滚</span></span><br><span class="line">        fmt.Prinf(<span class="string">&quot;exec sql1 failed, err: %v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    affRow1, err := ret1.RowAffected()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        tx.Rollback() <span class="comment">// 回滚</span></span><br><span class="line">        fmt.Printf(<span class="string">&quot;exec ret1.RowAffected() failed, err:%v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    sqlStr2 := <span class="string">&quot;UPDATE mt_subtitle_table set id = AAA4501 where actress = ?&quot;</span></span><br><span class="line">    ret2, err := tx.Exec(sqlStr2, <span class="string">&quot;泷泽萝拉&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err := <span class="literal">nil</span> &#123;</span><br><span class="line">        tx.Rollback() <span class="comment">// 回滚</span></span><br><span class="line">        fmt.Println(<span class="string">&quot;exec sql2 failed, err: %v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    affRow2, err := ret2.RowsAffected()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        tx.Rollback() <span class="comment">// 回滚</span></span><br><span class="line">        fmt.Printf(<span class="string">&quot;exec ret2.RosAffected() failed, err:%v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(affRow1, affRow2)</span><br><span class="line">    <span class="keyword">if</span> affRow1 == <span class="number">1</span> &amp;&amp; affRow2 == <span class="number">1</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;很好，事务提交了&quot;</span>)</span><br><span class="line">        tx.Commit() <span class="comment">// 提交事务</span></span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        tx.Rollback()</span><br><span class="line">        fmt.Println(<span class="string">&quot;不好意思，有点问题，事务回滚了&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;事务执行成功！&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;MySQL是常用的关系数据库，本文主要介绍Go语言怎么操作MySQL数据库。&lt;/p&gt;
&lt;p&gt;关键词：&lt;strong&gt;golang&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="mysql" scheme="https://fly97.cn/tags/mysql/"/>
    
    <category term="golang" scheme="https://fly97.cn/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Go语言基础（五）httprouter详解</title>
    <link href="https://fly97.cn/p/httprouter-tutorial-01/"/>
    <id>https://fly97.cn/p/httprouter-tutorial-01/</id>
    <published>2023-01-16T02:03:00.000Z</published>
    <updated>2023-01-16T02:03:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>httprouter是一个高性能、可扩展的HTTP路由，可以作为golang默认路由<code>net/http</code>的替代。</p><p>关键词：<strong>httprouter </strong></p><span id="more"></span><h2 id="安装">安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u  <span class="string">&quot;github.com/julienschmidt/httprouter&quot;</span></span><br></pre></td></tr></table></figure><p>一个例子作为开始</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/julienschmidt/httprouter&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HelloWorld</span><span class="params">(w http.ResponseWriter, r *http.Request, _ httprouter.Params)</span></span> &#123;</span><br><span class="line">w.Write([]<span class="type">byte</span>(<span class="string">&quot;HelloWorld&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">router := httprouter.New()</span><br><span class="line">router.GET(<span class="string">&quot;/hi&quot;</span>, HelloWorld)</span><br><span class="line">log.Fatal(http.ListenAndServe(<span class="string">&quot;:80&quot;</span>, router))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的代码中，HelloWorld是一个<code>handle httprouter.Handle</code>类型，需要传入三个参数，三个参数的作用以后说。该<code>handle</code>在main函数忠被注册到<code>/hi</code>路径上。运行代码会得到一下效果。</p><p><img data-src="image-20220416101901309.png" /></p><h2 id="http-method">HTTP Method</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Router)</span></span> GET(path <span class="type">string</span>, handle Handle) &#123;</span><br><span class="line">    r.Handle(<span class="string">&quot;GET&quot;</span>, path, handle)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Router)</span></span> HEAD(path <span class="type">string</span>, handle Handle) &#123;</span><br><span class="line">    r.Handle(<span class="string">&quot;HEAD&quot;</span>, path, handle)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Router)</span></span> OPTIONS(path <span class="type">string</span>, handle Handle) &#123;</span><br><span class="line">    r.Handle(<span class="string">&quot;OPTIONS&quot;</span>, path, handle)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Router)</span></span> POST(path <span class="type">string</span>, handle Handle) &#123;</span><br><span class="line">    r.Handle(<span class="string">&quot;POST&quot;</span>, path, handle)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Router)</span></span> PUT(path <span class="type">string</span>, handle Handle) &#123;</span><br><span class="line">    r.Handle(<span class="string">&quot;PUT&quot;</span>, path, handle)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Router)</span></span> PATCH(path <span class="type">string</span>, handle Handle) &#123;</span><br><span class="line">    r.Handle(<span class="string">&quot;PATCH&quot;</span>, path, handle)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Router)</span></span> DELETE(path <span class="type">string</span>, handle Handle) &#123;</span><br><span class="line">    r.Handle(<span class="string">&quot;DELETE&quot;</span>, path, handle)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="路由匹配">路由匹配</h2><h3 id="nethttp的路由匹配">net/http的路由匹配</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///api,可以访问到</span></span><br><span class="line"><span class="comment">///api/,不可以</span></span><br><span class="line">http.HandleFunc(<span class="string">&quot;/api&quot;</span>,<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter,r *http.Request)</span></span>&#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;/api&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">///api,可以</span></span><br><span class="line"><span class="comment">///api/,也可以</span></span><br><span class="line">http.HandleFunc(<span class="string">&quot;/api/&quot;</span>,<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter,r *http.Request)</span></span>&#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;/api&quot;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="httprouter的路由匹配">httprouter的路由匹配</h3><p>两者路由命名捕获方式：（是路由命名不是路由参数）</p><ul><li><p><code>:name</code>的捕获方式是匹配内容直到下一个斜线或者路径的结尾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Path: /blog/:category/:post  </span><br><span class="line">router.GET(<span class="string">&quot;/blog/:category/:post&quot;</span>, Hello) //category/post可以看成是一个变量</span><br><span class="line"></span><br><span class="line">当请求路径为：</span><br><span class="line">/blog/go/request-routers            match: category=<span class="string">&quot;go&quot;</span>, post=<span class="string">&quot;request-routers&quot;</span></span><br><span class="line">/blog/go/request-routers/           no match, but the router would redirect</span><br><span class="line">/blog/go/                           no match</span><br><span class="line">/blog/go/request-routers/comments   no match</span><br></pre></td></tr></table></figure></li><li><p><code>*name</code>的方式是从指定位置开始（包含前缀"/"）匹配到结尾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Path: /files/*filepath</span><br><span class="line">router.GET(<span class="string">&quot;/files/*filepath&quot;</span>, Hello) //filepath可以看成是一个变量</span><br><span class="line"></span><br><span class="line">当请求路径为：</span><br><span class="line">/files/                             match: filepath=<span class="string">&quot;/&quot;</span></span><br><span class="line">/files/LICENSE                      match: filepath=<span class="string">&quot;/LICENSE&quot;</span></span><br><span class="line">/files/templates/article.html       match: filepath=<span class="string">&quot;/templates/article.html&quot;</span></span><br><span class="line">/files                              no match, but the router would redirect</span><br></pre></td></tr></table></figure></li></ul><p>获取路由命名的参数</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HelloWorld</span><span class="params">(w http.ResponseWriter, r *http.Request, ps httprouter.Params)</span></span> &#123;</span><br><span class="line">    name := ps.ByName(<span class="string">&quot;who&quot;</span>) <span class="comment">//获取who对应的参数</span></span><br><span class="line">    name := ps[<span class="number">0</span>].Value      <span class="comment">//直接通过Value检索</span></span><br><span class="line">w.Write([]<span class="type">byte</span>(<span class="string">&quot;HelloWorld&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line">router.GET(<span class="string">&quot;/hi/:who&quot;</span>, HelloWorld)</span><br></pre></td></tr></table></figure><h3 id="httprouter重定向">httprouter重定向</h3><p>如果请求的URL路径包含或者不包含尾随斜线时，但在注册的路径上包含了或没有包含"/"的目标上定义了handler，但是会进行301重定向。简单地说，<strong>不管URL是否带尾随斜线，只要注册路径不存在，但在去掉尾随斜线或加上尾随斜线的路径上定义了handler，就会自动重定向。</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span></span> *Router &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;Router&#123;</span><br><span class="line"><span class="comment">//是否启用自动重定向</span></span><br><span class="line">        RedirectTrailingSlash:  <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 设置为true时回尝试修复路径, 第一个多余的路径会被删除. 之后, 路由器对已清理的路径进行不区分大小写的查找. 如果可以找到此路由的句柄，则路由器将重定向到正确的路径</span></span><br><span class="line">        RedirectFixedPath:      <span class="literal">true</span>,</span><br><span class="line">        HandleMethodNotAllowed: <span class="literal">true</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//如果启用，则路由器会自动回复OPTIONS请求</span></span><br><span class="line">        HandleOPTIONS:          <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面有几种会重定向的情况</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">注册路径：/blog/:category/:post</span><br><span class="line">请求URL路径：/blog/go/request-routers/</span><br><span class="line"></span><br><span class="line">注册路径：/blog/:category</span><br><span class="line">请求URL路径：/blog/go</span><br><span class="line"></span><br><span class="line">注册路径：/files/*filepath</span><br><span class="line">请求URL路径：/files</span><br></pre></td></tr></table></figure><h3 id="httprouter-lookup">httprouter lookup</h3><p>Lookup根据<code>method+path</code>检索对应的Handle，以及<code>Params</code>，并可以通过第三个返回值判断是否会进行重定向。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Router)</span></span> Lookup(method, path <span class="type">string</span>) (Handle, Params, <span class="type">bool</span>)</span><br></pre></td></tr></table></figure><h3 id="httprouter获取请求相关的信息">httprouter获取请求相关的信息</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HelloWorld</span><span class="params">(w http.ResponseWriter, r *http.Request, ps httprouter.Params)</span></span> &#123;</span><br><span class="line">err := r.ParseForm() <span class="comment">// 解析表单必须</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">w.WriteHeader(http.StatusBadGateway)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;Who: %v\n&quot;</span>, ps.ByName(<span class="string">&quot;who&quot;</span>))</span><br><span class="line">fmt.Printf(<span class="string">&quot;Method: %v\n&quot;</span>, r.Method)</span><br><span class="line">fmt.Printf(<span class="string">&quot;Host: %v\n&quot;</span>, r.Host)</span><br><span class="line">fmt.Printf(<span class="string">&quot;UserAgent: %v\n&quot;</span>, r.UserAgent())</span><br><span class="line">fmt.Printf(<span class="string">&quot;r.PostForm: %v\n&quot;</span>, r.PostForm)</span><br><span class="line">fmt.Printf(<span class="string">&quot;r.Form: %v\n&quot;</span>, r.Form)</span><br><span class="line">fmt.Println(<span class="string">&quot;========OK=======&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>其中PostForm获取<code>x-www-form-urlencoded</code>发送的表单，Form获取明文发送如http://127.0.0.1/hi/xxx?user=xxx如user=xxx的信息。</p><h3 id="http返回信息">http返回信息</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HelloWorld</span><span class="params">(w http.ResponseWriter, r *http.Request, ps httprouter.Params)</span></span> &#123;</span><br><span class="line">    w.WriteHeader(http.statusOK)</span><br><span class="line">    status, err := w.Write([]<span class="type">byte</span>&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> err := <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">    w.Header() </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>第一行返回http请求状态码</p><p>第二行返回Body，通常是返回一个json</p><p>第三行是返回Header，格式是map</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;httprouter
是一个高性能、可扩展的HTTP路由，可以作为golang默认路由&lt;code&gt;net/http&lt;/code&gt;的替代。&lt;/p&gt;
&lt;p&gt;关键词：&lt;strong&gt;httprouter &lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="golang" scheme="https://fly97.cn/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>http请求参数之Query String Parameters、Form Data、Request Payload区别</title>
    <link href="https://fly97.cn/p/the-difference-between-query-string-parameters-and-form-data-and-request-payload/"/>
    <id>https://fly97.cn/p/the-difference-between-query-string-parameters-and-form-data-and-request-payload/</id>
    <published>2023-01-05T02:20:00.000Z</published>
    <updated>2023-01-05T02:20:00.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>在与server端进行数据传递时，通常会用到GET、POST方法进行参数提交，而参数提交的方式，通常取决于server端对数据的接收方式。</strong></p><p>关键词：<strong>http</strong></p><span id="more"></span><h2 id="query-string-parameters">Query String Parameters</h2><p>Query String Parameters 当发起一次HTTP请求时，参数会以urlstring的形式进行传递。</p><p>即<code>?</code>后面的字符串则为请求的参数，并以<code>&amp;</code>为分隔符。</p><h4 id="header">header</h4><p><img data-src="1620.png" /></p><h4 id="传入参数">传入参数</h4><p><img data-src="1620-1672985410153-3.png" /></p><h2 id="request-payload">Request Payload</h2><p>当发起一次POST请求后，若<code>content-type</code>为<code>application/json</code>，则参数会以RequestPayload的形式进行传递，数据形式为JSON。</p><p>上述请求不会显式的出现在URL中。</p><h4 id="header-1">header</h4><p><img data-src="1620-1672985432471-6.png" /></p><h4 id="传入参数-1">传入参数</h4><figure><img data-src="1620-1672985616176-9.png" alt="img" /><figcaption aria-hidden="true">img</figcaption></figure><h2 id="form-data">Form Data</h2><p>当发起一次HTTP请求时，若未指定content-type，则默认<code>content-type</code>为<code>application/x-www-form-urlencoded</code>。</p><p>参数会以<code>From Data</code>的形式进行传递，不会显式出现在请求url中。</p><h4 id="传入参数-2">传入参数</h4><p><img data-src="1620-1672985628992-12.png" /></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;strong&gt;在与server端进行数据传递时，通常会用到GET、POST方法进行参数提交，而参数提交的方式，通常取决于server端对数据的接收方式。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;关键词：&lt;strong&gt;http&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="http" scheme="https://fly97.cn/tags/http/"/>
    
  </entry>
  
  <entry>
    <title>ROS实战（十一）ROS2之节点</title>
    <link href="https://fly97.cn/p/agent-in-ros2/"/>
    <id>https://fly97.cn/p/agent-in-ros2/</id>
    <published>2022-12-20T10:36:00.000Z</published>
    <updated>2022-12-20T10:36:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要介绍ROS2上的节点。</p><p><strong>关键词：ROS2</strong></p><span id="more"></span><h2 id="节点">节点</h2><p>机器人是各种功能的综合体，每一项功能就像机器人的一个工作细胞。众多细胞通过一些机制联系到一起，就成为了一个机器人整体。</p><p>在ROS中，这些细胞被称为节点。</p><h3 id="通信模型">通信模型</h3><p>完成的机器人系统可能并不是一个物理上的整体，比如这样的一个机器人：</p><p><img data-src="image-20220526231417594.png" /></p><p>在机器人身体里搭载了一台计算机A，通过机器人的眼睛——摄像头，获取外界的信息，也可以通过控制机器人的腿——轮子，让机器人一栋栋到想要去的地方。除此之外，还有另外一台计算机B，放在你的桌子上，可以远程监控机器人看到的消息，也可以远程配置机器人的速度和某些参数，还可以连接成为一个摇杆，人为控制机器人左右运动。</p><p>这些功能虽然位于不同的计算机中，但是都是机器人的工作细胞，也就是节点，他们共同组成了一个完整的机器人系统。</p><ul><li>节点在机器人系统中的职责就是<strong>执行某些具体的任务</strong>，从操作系统来看，也叫做进程；</li><li>每个节点都是一个<strong>独立运行的可执行文件，</strong>比如执行某一个python程序，或者执行C++编译生成的结果，都是算运行了一个节点；</li><li>既然每一个节点都是独立的执行文件，那自然就可以想到，得到这个执行文件的编程语言可以是不同的，比如C++、Python等；</li><li>这些节点是功能各不相同的细胞，根据系统设计的不同，可能位于计算机A，也可能位于计算机B</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文主要介绍ROS2上的节点。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;关键词：ROS2&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="ROS" scheme="https://fly97.cn/tags/ROS/"/>
    
  </entry>
  
  <entry>
    <title>ROS实战（十一）ROS2之功能包</title>
    <link href="https://fly97.cn/p/package-in-ros2/"/>
    <id>https://fly97.cn/p/package-in-ros2/</id>
    <published>2022-12-19T10:36:00.000Z</published>
    <updated>2022-12-19T10:36:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要介绍ROS2上的功能包。</p><p><strong>关键词：ROS2</strong></p><span id="more"></span><p>功能包的机制，是提高ROS中软件复用率的重要方法。</p><h2 id="创建功能包">创建功能包</h2><p>如何在ROS2中创建一个功能包，可以使用以下这个指令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 pkg create --build-type &lt;build-type&gt; &lt;package_name&gt;</span><br></pre></td></tr></table></figure><ul><li>pkg：表示功能包相关的功能；</li><li>create：表示创建功能包；</li><li>build-type：表示新创建的功能包是C++还是Python的，如果是C++或者C，那这里就用ament_cmake，如果使用Python，就用ament_python；</li><li>package_name：新建功能包的名字。</li></ul><p>比如在终端中分别创建C++和Python版本的功能包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/dev_ws/src</span><br><span class="line">ros2 pkg create --build-type ament_cmake learning_pkg_c            <span class="comment"># C++</span></span><br><span class="line">ros2 pkg create --build-type ament_python learning_pkg_python      <span class="comment"># Python</span></span><br></pre></td></tr></table></figure><h2 id="编译功能包">编译功能包</h2><p>在创建好的功能包中，可以继续完成代码的编写，之后需要编译和配置环境变量，才能正常运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/dev_ws/src</span><br><span class="line">colcon build      <span class="comment"># 编译工作空间所有功能包</span></span><br><span class="line"><span class="built_in">source</span> install/local_setup.bash</span><br></pre></td></tr></table></figure><h2 id="功能包的结构">功能包的结构</h2><p>分析以下刚刚创建的两个功能包的结构。</p><h3 id="c功能包">C++功能包</h3><p>首先看下C++的功能包，其中必然存在两个文件：<strong>package.xml和CMakerLists.txt</strong></p><p><img data-src="image-20220524112122164.png" /></p><p>package.xml文件的主要内容如下，包含功能包的版权描述，和各种依赖的声明。</p><p><img data-src="image-20220524112141298.png" /></p><p>CMakeLists.txt文件是编译规则，C++代码需要编译才能运行，必须要在该文件中设置如何编译，使用CMake语法。</p><p><img data-src="image-20220524112132626.png" /></p><p>Python功能包</p><p>C++功能包需要将源码解释成可执行文件，但是Python语言是解析型的，不需要编译。</p><p>也是有两个文件：package.xml和setup.py。</p><p><img data-src="image-20220524112228806.png" /></p><p>package.xml文件的主要内容和C++版本的功能包一样，包含功能包的版权描述，和各自依赖的声明。</p><p><img data-src="image-20220524112246102.png" /></p><p>setup.py文件里面也包含一些版权信息，初次之外，还有"entry_points"配置的程序入口。</p><p><img data-src="image-20220524112235574.png" /></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文主要介绍ROS2上的功能包。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;关键词：ROS2&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="ROS" scheme="https://fly97.cn/tags/ROS/"/>
    
  </entry>
  
  <entry>
    <title>ROS实战（十）ROS2之工作空间</title>
    <link href="https://fly97.cn/p/workspace-in-ros2/"/>
    <id>https://fly97.cn/p/workspace-in-ros2/</id>
    <published>2022-12-17T10:36:00.000Z</published>
    <updated>2022-12-17T10:36:00.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要：转眼间三年已经过去，而我也开始面临毕业的问题。由于导师放养式的教学，导致我的论文一直没什么长进。抱怨没有用，一切靠自己。还是得把之前丢下的捡起来。</strong></p><p>本文主要介绍ROS2上的工作空间。</p><p><strong>关键词：ROS2</strong></p><span id="more"></span><h2 id="工作空间开发过程中的大本营">工作空间：开发过程中的大本营</h2><h3 id="什么是工作空间">什么是工作空间</h3><p>在ROS机器人开发中，我们针对机器人的某些功能需要进行代码便携式，各种编写的代码、参数、脚本等文件，也需要放置在某一个文件夹里进行管理，这个文件夹在ROS系统中就叫做工作空间。</p><p>工作空间是一个存放项目于开发相关文件的文件夹，是开发过程中存放所有资料的大本营。</p><p>ROS系统中一个典型的工作空间如下，一般会有四个子目录：</p><figure><img data-src="https://book.guyuehome.com/ROS2/2.%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5/image/2.1_%E5%B7%A5%E4%BD%9C%E7%A9%BA%E9%97%B4/image-20220524111415729.png"alt="image-20220524111415729" /><figcaption aria-hidden="true">image-20220524111415729</figcaption></figure><ul><li><p><strong>src，代码空间</strong>：编写的代码、脚本都需要放在这里；</p></li><li><p><strong>build，编译空间</strong>：保存编译过程中产生的中间文件；</p></li><li><p><strong>install，安装空间</strong>：放置编译过程得到的可执行文件和脚本；</p></li><li><p><strong>log，日志空间</strong>：编译和运行过程中，保存各种警告、错误、信息等日志。</p></li></ul><p>总体来说，这四个空间的文件夹，我们绝大部分的操作都是在src进行的，编译成功后，会执行install里面的结果，build和log两个文件很少用。</p><p>工作空间里的名称我们也可以自己定义，数量也不是唯一的.</p><h3 id="创建工作空间">创建工作空间</h3><p>执行以下命令创建工作空间</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p ~/dev_ws/src</span><br><span class="line"><span class="built_in">cd</span> ~/dev_ws/src</span><br><span class="line">git <span class="built_in">clone</span> https://gitee.com/guyuehome/ros2_21_tutorials.git</span><br></pre></td></tr></table></figure><h3 id="自动安装依赖">自动安装依赖</h3><p>一般使用<code>rosdep</code>工具进行自动安装，而<code>rosdep</code>默认会使用国外的源进行安装，而一般国内的网络无法正常连接，因此有开发者开发了<code>rosdepc</code>模块，<code>c</code>的含义就是china，这个软件使用了清华源进行了替换。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install rosdepc</span><br><span class="line">sudo rosdepc init </span><br><span class="line">rosdepc update</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">rosdepc install -i --from-path src --rosdistro foxy -y</span><br></pre></td></tr></table></figure><p><img data-src="2022-12-17-16-30-20-image.png" /></p><h3 id="编译工作空间">编译工作空间</h3><p>依赖安装完毕，可以使用以下命令编译工作空间，如果有缺少的依赖，或者代码有错误，编译过程中会有报错，否则编译过程中不会出现任何错误：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python3-colcon-ros</span><br><span class="line"><span class="built_in">cd</span> ~/dev_ws/</span><br><span class="line">colcon build</span><br></pre></td></tr></table></figure><p><img data-src="2022-12-17-16-37-46-image.png" /></p><p>编译成功后，就可以在工作空间后就可以看到构建后的文件夹了</p><p><img data-src="2022-12-17-16-40-47-image.png" /></p><h3 id="设置环境变量">设置环境变量</h3><p>编译成功后，为了让系统找到我们的功能包和可执行文件，还需要设置环境变量：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> install/local_setup.sh <span class="comment"># 仅在当前终端生效</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;source ~/dev_ws/install/local_setup.sh&quot;</span> &gt;&gt; ~/.bashrc <span class="comment"># 全局生效</span></span><br></pre></td></tr></table></figure><p>至此，我们就完成了工作空间的创建、编译、和配置。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;strong&gt;摘要：转眼间三年已经过去，而我也开始面临毕业的问题。由于导师放养式的教学，导致我的论文一直没什么长进。抱怨没有用，一切靠自己。还是得把之前丢下的捡起来。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;本文主要介绍ROS2上的工作空间。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;关键词：ROS2&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="ROS" scheme="https://fly97.cn/tags/ROS/"/>
    
  </entry>
  
  <entry>
    <title>ROS实战（九）安装ROS2</title>
    <link href="https://fly97.cn/p/install-ros2-with-linux/"/>
    <id>https://fly97.cn/p/install-ros2-with-linux/</id>
    <published>2022-12-16T10:36:00.000Z</published>
    <updated>2022-12-16T10:36:00.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要：转眼间三年已经过去，而我也开始面临毕业的问题。由于导师放养式的教学，导致我的论文一直没什么长进。抱怨没有用，一切靠自己。还是得把之前丢下的捡起来。</strong></p><p>本文主要介绍如何在Linux平台上安装ROS2。</p><p><strong>关键词：ROS2</strong> <span id="more"></span></p><h2 id="ros2安装">ROS2安装</h2><p>ROS2的安装受ubuntu发行版的限制，比如ubuntu 20.04LTS只能安装foxy这个发行版；</p><p>ubuntu 22.04 LTS只能按照ROS2长期支持版humble这个发行版。</p><p>本文以ubuntu 20.04 LTS安装foxy发行版为例。</p><h3 id="设置编码">设置编码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update &amp;&amp; sudo apt install locales</span><br><span class="line">sudo locale-gen en_US en_US.UTF-8</span><br><span class="line">sudo update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8 </span><br><span class="line"><span class="built_in">export</span> LANG=en_US.UTF-8</span><br></pre></td></tr></table></figure><h3 id="安装必要软件">安装必要软件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update &amp;&amp; sudo apt install curl gnupg lsb-release software-properties-common</span><br><span class="line">sudo add-apt-repository universe</span><br></pre></td></tr></table></figure><h3 id="设置源">设置源</h3><p>此处注意，需要确认你的网络可以连接<code>raw.githubusercontent.com</code>，这里先下载完key然后上传到服务器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key</span><br><span class="line">sudo <span class="built_in">mv</span> ros.key /usr/share/keyrings/ros-archive-keyring.gpg </span><br></pre></td></tr></table></figure><p>这里使用清华源</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [arch=<span class="subst">$(dpkg --print-architecture)</span> signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] https://mirrors.tuna.tsinghua.edu.cn/ros2/ubuntu jammy main&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/ros2.list &gt; /dev/null</span><br><span class="line"></span><br><span class="line">sudo apt update</span><br></pre></td></tr></table></figure><h3 id="安装ros2">安装ROS2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt upgrade</span><br><span class="line">sudo apt install ros-foxy-desktop python3-argcomplete -y</span><br></pre></td></tr></table></figure><p>注意，如果是嵌入式设备，使用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ros-foxy-ros-base python3-argcomplete -y </span><br></pre></td></tr></table></figure><p>如果需要安装编译的环境</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ros-dev-tools -y</span><br></pre></td></tr></table></figure><h3 id="设置环境变量">设置环境变量</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/ros/foxy/setup.bash</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot; source /opt/ros/foxy/setup.bash&quot;</span> &gt;&gt; ~/.bashrc </span><br></pre></td></tr></table></figure><h2 id="ros2测试">ROS2测试</h2><h3 id="命令行">命令行</h3><p>启动一个终端，允许一个数据的发布者节点：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 run demo_nodes_cpp talker</span><br></pre></td></tr></table></figure><p><img data-src="2022-12-16-20-48-59-image.png" /></p><p>启动第二个终端，通过以下命令启动一个数据的订阅者节点：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 run demo_nodes_py listener</span><br></pre></td></tr></table></figure><p><img data-src="2022-12-16-20-49-55-image.png" /></p><h3 id="gui">GUI</h3><p>运行一个ROS的经典实例——小海龟仿真器</p><p>启动两个终端，分别执行如下指令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ros2 run turtlesim turtlesim_node</span><br><span class="line">ros2 run turtlesim turtle_teleop_key</span><br></pre></td></tr></table></figure><p>第一句指令将启动一个蓝色背景的海龟仿真器，第二局指令将启动一个键盘控制节点，在该终端中点击键盘上的上下左右按键，就可以控制小海龟移动了。</p><h2 id="常见的命令行操作">常见的命令行操作</h2><p>ROS2的命令行的操作机制与Linux相同，不过所有的操作都集中在ros2的总命令中，后面第一个参数表示不同的操作目的，比如node表示对节点的操作，topic表示对话题的操作，后面还可以继续跟参数表示具体操作。</p><p><img data-src="2022-12-17-12-27-08-image.png" /></p><p>接下来以小乌龟仿真为例，感受下ROS2命令行的主要功能，也对ROS2中的核心概念有一个大体了解。</p><h3 id="运行节点程序">运行节点程序</h3><p>想要运行ROS2中的某个节点，可以使用ros2 run命令进行操作。</p><p>例如我们要运行海龟仿真节点：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 run turtlesim turtlesim_node</span><br></pre></td></tr></table></figure><p><img data-src="2022-12-17-12-36-55-image.png" /></p><p>我们要运行键盘控制节点：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 run turtlesim turtle_teleop_key</span><br></pre></td></tr></table></figure><p><img data-src="2022-12-17-12-41-35-image.png" /></p><h3 id="查看节点信息">查看节点信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 node list</span><br></pre></td></tr></table></figure><p><img data-src="2022-12-17-12-46-11-image.png" /></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 node info /turtlesim</span><br></pre></td></tr></table></figure><p><img data-src="2022-12-17-12-47-32-image.png" /></p><h3 id="查看话题信息">查看话题信息</h3><p>使用以下命令即可查看：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 topic list</span><br></pre></td></tr></table></figure><p><img data-src="2022-12-17-12-48-52-image.png" /></p><p>查看指定话题的消息数据</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 topic <span class="built_in">echo</span> /turtle1/pose</span><br></pre></td></tr></table></figure><h3 id="发布话题消息">发布话题消息</h3><p>想让海龟直接动起来，可以直接通过命令行发布话题指令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 topic pub --rate 1 /turtule1/cmd_vel geometry_msgs/msg/Twist <span class="string">&quot;&#123;linear: &#123;x: 2.0, y: 0.0, z: 0.0&#125;, angular: &#123;x: 0.0, y: 0.0, z: 1.8&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure><p><img data-src="2022-12-17-13-59-05-image.png" /></p><h3 id="发送服务请求">发送服务请求</h3><p>一只小海龟太孤单，仿真器还提供了另外一个服务，产生海龟，我们试一试服务调用，再来一只小海龟，图片也如上图所示</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 service call /spawn turtlesim/srv/Spwan <span class="string">&quot;&#123;x: 2, y: 2, theta: 0.2, name:&#x27;&#x27;&#125;&quot;</span><span class="string">&quot;</span></span><br></pre></td></tr></table></figure><h3 id="发送动作目标">发送动作目标</h3><p>想让海龟完成一个具体动作，比如转到指定角度，仿真器提供的action可以实现：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 action send_goal /turtle1/rotate_absolute turtlesim/action/RotateAbsolute <span class="string">&quot;theta: 3&quot;</span></span><br></pre></td></tr></table></figure><p>再继续发布上述话题的基础上，会发现小乌龟在转变了角度以后继续转圈：</p><p><img data-src="2022-12-17-14-01-39-image.png" /></p><h3 id="录制控制命令">录制控制命令</h3><p>系统中运行的数据有很多，如果想要把某段数据录制下来，然后再复现这段数据。</p><p>ros2中的rosbag命令可以实现上面的需求：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ros2 bag record /turtle1/cmd_vel</span><br><span class="line">ros2 bag play rosbag2_2022_04_11-17_35_40/rosbag2_2022_04_11-17_35_40_0.db3</span><br></pre></td></tr></table></figure><p><img data-src="2022-12-17-14-04-20-image.png" /></p><p>以上就是ROS2中的常见命令。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;strong&gt;摘要：转眼间三年已经过去，而我也开始面临毕业的问题。由于导师放养式的教学，导致我的论文一直没什么长进。抱怨没有用，一切靠自己。还是得把之前丢下的捡起来。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;本文主要介绍如何在Linux平台上安装ROS2。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;关键词：ROS2&lt;/strong&gt;</summary>
    
    
    
    
    <category term="ROS" scheme="https://fly97.cn/tags/ROS/"/>
    
  </entry>
  
  <entry>
    <title>ROS实战（八）ROS2初探</title>
    <link href="https://fly97.cn/p/hello-to-ros2/"/>
    <id>https://fly97.cn/p/hello-to-ros2/</id>
    <published>2022-12-15T09:36:00.000Z</published>
    <updated>2022-12-15T09:36:00.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要：转眼间三年已经过去，而我也开始面临毕业的问题。由于导师放养式的教学，导致我的论文一直没什么长进。抱怨没有用，一切靠自己。还是得把之前丢下的捡起来。</strong></p><p>本文主要介绍ROS2.</p><p><strong>关键词：ROS2</strong></p><span id="more"></span><h2 id="为什么是ros2">为什么是ROS2</h2><p>ROS2是一个全新的机器人操作系统，在借鉴ROS1成功经验的基础上，对系统架构和软件代码全部进行了重新设计和实现。与ROS1相比，体现在以下几点：</p><figure><img data-src="https://book.guyuehome.com/ROS2/1.%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/image/1.2_ROS2%E5%AF%B9%E6%AF%94ROS1/image-20220523114359304.png"alt="image-20220523114359304" /><figcaption aria-hidden="true">image-20220523114359304</figcaption></figure><ul><li><p><strong>系统出现了颠覆性的变化</strong>，ROS1的所有节点都需要在节点管理器ROSMaster下进行工作，一旦Master出现问题，系统就会宕机。ROS2实现了真正的分布式，不再有Master这个角色，借助全新的通信框架DDS，为所有节点提供了可靠通信保障。</p></li><li><p><strong>软件API进行了重新设计</strong>，ROS1原有的接口无法满足需求，ROS2结合C++最新标准和Python3语言特性，设计了更具通用的API，虽然导致原有ROS1的代码无法直接在ROS2上运行，但是尽量保留了类似的使用方法，同时提供了大量的移植说明。</p></li><li><p><strong>编译系统进行了升级</strong>，ROS1仲使用的rosbuild和catkin问题诸多，尤其是针对代码比较多的项目以及Python编写的项目。编译、连接经常会出错，ROS2对这些进行了优化，重新优化后的编译系统叫做<strong>ament和colcon</strong>。</p><p>以上几点是框架层面的优化，而ROS1和ROS2的明显变化，请看下文：</p><h2 id="ros2-vs-ros1">ROS2 vs ROS1</h2><h3 id="系统架构">系统架构</h3><figure><img data-src="https://book.guyuehome.com/ROS2/1.%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/image/1.2_ROS2%E5%AF%B9%E6%AF%94ROS1/image26-16532775781034.png"alt="image26" /><figcaption aria-hidden="true">image26</figcaption></figure><p>如图所示，可以看出最大的变化就是<strong>Master。</strong></p></li><li><p>ROS1中，应用层里面的<strong>Master</strong>节点管理器至关重要，所有节点都得听他指挥。ROS2把这个不稳定的角色请走了，节点可以通过自发现机制找到彼此，从而建立稳定的通信连接；</p></li><li><p>中间层是ROS封装好的标准通信接口，写程序会频繁和这些接口打交道，比如发布一个图像的数据，接受一个雷达的信息，客户端库再调用底层复杂的驱动和通信协议，使得我们的开发变得更加明了。</p></li><li><p>ROS1中，ROS通信依赖底层的TCP和UDP通信，ROS2中，通信协议换成了更见复杂但更见完善的DDS系统；</p></li><li><p>如果是进程内需要大量数据的通信，ROS1和ROS2都提供了基于共享内存的通信方法，只不过名字不太一样；</p></li><li><p>最下面是系统层，也就是ROS可以安装在那些操作系统上，ROS1主要安装在Linux上，ROS2的可选项很多，Linux、Windows、MacOS、RTOS都可以；</p></li></ul><h3 id="dds通信">DDS通信</h3><figure><img data-src="https://book.guyuehome.com/ROS2/1.%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/image/1.2_ROS2%E5%AF%B9%E6%AF%94ROS1/image27.png"alt="image27" /><figcaption aria-hidden="true">image27</figcaption></figure><p>ROS1中基于TCP/UDP的通信系统，频繁诟病与延迟、丢数据、无法加密等问题，ROS2中的DDS在通信层面的功能就丰富多了；</p><p>DDS是物联网中广泛得到应用的一种通信协议。DDS是一个国际标准，能够实现该标准的软件系统并不是唯一的，可以选择多个厂家提供的DDS系统，比如<strong>OpenSplice、FastRTPS</strong>，还有更多厂家提供的，<strong>每一家的性能不同，适用的场景也不一样</strong>；</p><p>ROS2设计了个ROSMiddleware，RMW，也就是指定一个标准的接口，<strong>比如如何发数据、如何收数据，数据的各自属性如何配置，等</strong>。如果厂家想要接入DDS社区，需要按照这个标准写一个适配的接口，将自家的DDS移植过来，这样问题交给了熟悉自家的DDS厂家。</p><p><strong>当我们在产品开发时，可以先用开源版本的DDS满足业务需求，部署交付的产品时，再更改为商业版本更加稳定的DDS，减少开发成本。</strong></p><p>总之，DDS的加入，让ROS2更加稳定，也更加灵活，与之相同的时复杂度也会变高。这样我们不用在纠结ROS的通信系统是否稳定、应该如何优化等问题，更多精力可以放在其他三个部分，专注优化机器人应用功能。</p><h3 id="核心概念">核心概念</h3><p>ROS1应用以及非常广泛，全球有几百万开发者，大家已经熟悉了ROS1的开发方式和其中很多的概念。ROS2尽量保留了这些概念，以便开发者从ROS1迁移到ROS2。</p><figure><img data-src="https://book.guyuehome.com/ROS2/1.%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/image/1.2_ROS2%E5%AF%B9%E6%AF%94ROS1/image-20220523114814371.png"alt="image-20220523114814371" /><figcaption aria-hidden="true">image-20220523114814371</figcaption></figure><h3 id="编码方式">编码方式</h3><p>如果各位熟悉ROS1，这里的概念应该并不陌生，在ROS2中，这些概念依然存在，意义也几乎一致，在本课程的第二个部分，我们就会一一讲解这些概念的含义和使用方法，没有学习过ROS的小伙伴也不用担心。</p><figure><img data-src="https://book.guyuehome.com/ROS2/1.%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/image/1.2_ROS2%E5%AF%B9%E6%AF%94ROS1/image-20220523114851763.png"alt="image-20220523114851763" /><figcaption aria-hidden="true">image-20220523114851763</figcaption></figure><p>总体而言，ROS2会用到更多面向对象的实现方法和语言特性，从编程语言的角度来讲，难度确实会提高一些，不过当我们迈过这道坎之后，就会发现我们写的程序会更具备可读性和可移植性，也会更接接近真实企业中机器人软件开发的过程。</p><h3 id="命令行"><strong>命令行</strong></h3><p>最后我们再对比下ROS开发中最为常用的一种工具——命令行。</p><figure><img data-src="https://book.guyuehome.com/ROS2/1.%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/image/1.2_ROS2%E5%AF%B9%E6%AF%94ROS1/image-20220523114915528.png"alt="image-20220523114915528" /><figcaption aria-hidden="true">image-20220523114915528</figcaption></figure><p>ROS1中的命令行相对分散，每一个功能都是一个独立的命令，比如rosrun启动某一个节点，rostopic控制话题相关的功能。</p><p>ROS2对命令行做了大幅度的集成，所有命令都集成在一个ros2的主命令中，比如ros2run，表示启动某一个节点，ros2 topic表示话题相关的功能。</p><h2 id="总结">总结</h2><p>ROS2和ROS1相比，总结如下：</p><ul><li><strong>节点干掉了Master</strong></li><li><strong>通信换成了DDS</strong></li><li><strong>核心概念没变化</strong></li><li><strong>编程难度有上升</strong></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;strong&gt;摘要：转眼间三年已经过去，而我也开始面临毕业的问题。由于导师放养式的教学，导致我的论文一直没什么长进。抱怨没有用，一切靠自己。还是得把之前丢下的捡起来。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;本文主要介绍ROS2.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;关键词：ROS2&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="ROS" scheme="https://fly97.cn/tags/ROS/"/>
    
  </entry>
  
  <entry>
    <title>Go语言基础（四）客户端模拟发送HTTP请求</title>
    <link href="https://fly97.cn/p/how-to-send-http-request-in-go/"/>
    <id>https://fly97.cn/p/how-to-send-http-request-in-go/</id>
    <published>2022-12-10T10:33:00.000Z</published>
    <updated>2022-12-10T10:33:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>在Golang中web开发中net/http是经常用到的包，在这个包中包含了各种请求与响应的方式，下面我会一一进行介绍。</p><p>关键词：<strong>golang</strong></p><span id="more"></span><h2 id="get请求">GET请求</h2><h3 id="不带参数的get请求">不带参数的GET请求</h3><p>直接使用http.Get()函数，返回一个<code>*http.Response</code>类型的变量，使用<code>os.ReadAll(resp.Body)</code>会读取相应后内容</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SendSimpleGetRequest</span><span class="params">()</span></span> &#123;</span><br><span class="line">response, err := http.Get(<span class="string">&quot;https://www.baidu.com&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> response.Body.Close()</span><br><span class="line">s, err := io.ReadAll(response.Body)</span><br><span class="line">fmt.Println(<span class="type">string</span>(s))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="携带参数的get请求">携带参数的GET请求</h3><p>使用<code>url.Values&#123;&#125;</code>返回一个<code>map[string][]string</code>类型，不推荐直接在url地址中携带。</p><p>可以使用<code>params.Encode()</code>对中文进行编码，防止数据在传输过程中出错。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SendComplexGetRequest</span><span class="params">()</span></span> &#123;</span><br><span class="line">params := url.Values&#123;&#125;</span><br><span class="line">urlObj, err := url.Parse(<span class="string">&quot;http://www.baidu.com&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">params.Set(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;afds&quot;</span>)</span><br><span class="line">params.Set(<span class="string">&quot;id&quot;</span>, <span class="type">string</span>(<span class="string">&quot;1&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果有中文参数，这个操作会对中文参数进行解析</span></span><br><span class="line">urlObj.RawQuery = params.Encode()</span><br><span class="line">urlPath := urlObj.String()</span><br><span class="line">resp, err := http.Get(urlPath)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">response, err := io.ReadAll(resp.Body)</span><br><span class="line">fmt.Printf(<span class="string">&quot;response: %s\n&quot;</span>, response)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="post-请求">Post 请求</h2><h3id="post请求applicationx-www-form-urlencoded">Post请求：application/x-www-form-urlencoded</h3>这应该是最常见的 POST 提交数据的方式了。浏览器的原生<form><p>表单，如果不设置 <code>enctype</code> 属性，那么最终就会以<code>application/x-www-form-urlencoded</code> 方式提交数据</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">httpPostForm</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// params := url.Values&#123;&#125;</span></span><br><span class="line"><span class="comment">// params.Set(&quot;id&quot;, &quot;123&quot;)</span></span><br><span class="line">params := url.Values&#123;</span><br><span class="line"><span class="string">&quot;key&quot;</span>: &#123;<span class="string">&quot;value&quot;</span>&#125;,</span><br><span class="line"><span class="string">&quot;id&quot;</span>:  &#123;<span class="string">&quot;123&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line">resp, _ := http.PostForm(<span class="string">&quot;http://baidu.com&quot;</span>, params)</span><br><span class="line">fmt.Println(<span class="string">&quot;request header[Content-Type]:&quot;</span>, resp.Request.Header[<span class="string">&quot;Content-Type&quot;</span>])</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">s, _ := io.ReadAll(resp.Body)</span><br><span class="line">fmt.Println(<span class="type">string</span>(s))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="post请求multipartform-data">Post请求：multipart/form-data</h3><p>multipart/form-data的基础方法是post，其请求头必须包含一个特殊的头信息：<code>Content-Type</code>，值为<code>multipart/form-data</code>，同时还需要规定一个内容分割符用于分割请求体中的多个post的内容。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">httpPostMultipartField</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">url := <span class="string">&quot;/qb/api/v2/auth/login&quot;</span></span><br><span class="line">method := <span class="string">&quot;POST&quot;</span></span><br><span class="line"></span><br><span class="line">body := &amp;bytes.Buffer&#123;&#125;</span><br><span class="line">writer := multipart.NewWriter(body)</span><br><span class="line">err := writer.WriteField(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;fly97&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">err = writer.WriteField(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;xxxx&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">err = writer.Close()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">req, err := http.NewRequest(method, url, body)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">req.Header.Set(<span class="string">&quot;Content-Type&quot;</span>, writer.FormDataContentType())</span><br><span class="line">resp, err := http.DefaultClient.Do(req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;request header[Content-Type]:&quot;</span>, resp.Request.Header[<span class="string">&quot;Content-Type&quot;</span>])</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line">response, err := io.ReadAll(resp.Body)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;response: %s&quot;</span>, response)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="客户端通用模式">客户端通用模式</h2><p>一般遵循以下的顺序：</p><ol type="1"><li>使用<code>http.Client&#123;&#125;</code>实例化一个客户端；</li><li>使用<code>http.NewRequest()</code>新创建一个请求；</li><li>设置请求头<code>req.Header.Set()</code>；</li><li>使用<code>client.Do(req)</code>发送请求；</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">httpDo</span><span class="params">()</span></span> &#123;</span><br><span class="line">    client := &amp;http.Client&#123;&#125;</span><br><span class="line"></span><br><span class="line">    urlmap := url.Values&#123;&#125;</span><br><span class="line"></span><br><span class="line">    urlmap.Add(<span class="string">&quot;client_id&quot;</span>, <span class="string">&quot;esss&quot;</span>)</span><br><span class="line">    urlmap.Add(<span class="string">&quot;client_secret&quot;</span>, <span class="string">&quot;sk&quot;</span>)</span><br><span class="line">    parms := ioutil.NopCloser(strings.NewReader(urlmap.Encode())) <span class="comment">//把form数据编下码</span></span><br><span class="line">    req, err := http.NewRequest(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;www.baidu.com&quot;</span>, parms)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// handle error</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    req.Header.Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>)</span><br><span class="line">    req.Header.Set(<span class="string">&quot;Cookie&quot;</span>, <span class="string">&quot;name=anny&quot;</span>)</span><br><span class="line"></span><br><span class="line">    resp, err := client.Do(req)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line">    body, err := ioutil.ReadAll(resp.Body)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// handle error</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="type">string</span>(body))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;在Golang中web开发中net/http是经常用到的包，在这个包中包含了各种请求与响应的方式，下面我会一一进行介绍。&lt;/p&gt;
&lt;p&gt;关键词：&lt;strong&gt;golang&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="golang" scheme="https://fly97.cn/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>一些常见的运维操作</title>
    <link href="https://fly97.cn/p/common-operation-and-maintenance-operations/"/>
    <id>https://fly97.cn/p/common-operation-and-maintenance-operations/</id>
    <published>2022-12-10T05:28:00.000Z</published>
    <updated>2022-12-10T05:28:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>关键词：<strong>运维操作</strong></p><span id="more"></span><h3 id="sudo无需输入密码">sudo无需输入密码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;%sudo ALL=(ALL) NOPASSWD:ALL&quot;</span> &gt;&gt; /etc/sudoers</span><br></pre></td></tr></table></figure><h3 id="一键安装docker">一键安装docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL get.docker.com -o get-docker.sh</span><br><span class="line"><span class="comment"># sudo sh get-docker.sh --mirror </span></span><br><span class="line">sudo sh get-docker.sh --mirror Aliyun</span><br></pre></td></tr></table></figure><h3 id="docker需要使用sudo">docker需要使用sudo</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo groupadd docker</span><br><span class="line">sudo gpasswd -a <span class="variable">$&#123;USER&#125;</span> docker</span><br><span class="line">sudo service docker restart</span><br><span class="line">newgrp - docker</span><br></pre></td></tr></table></figure><h3 id="查看文件夹占用">查看文件夹占用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo du -s /* | sort -nr</span><br><span class="line">sudo du -h  --max-depth=1</span><br></pre></td></tr></table></figure><h3 id="清理docker冗余容器">清理docker冗余容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker system prune -a</span><br></pre></td></tr></table></figure><h3 id="清理k3s冗余容器">清理k3s冗余容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo k3s crictl rmi --prune</span><br></pre></td></tr></table></figure><h3 id="systemctl定时执行任务">Systemctl定时执行任务</h3><p>参考</p><ol type="1"><li><p><ahref="https://www.cnblogs.com/operationhome/p/10720067.html">Linux定时任务 crontab 和 Systemd Timer - 自由早晚乱余生 - 博客园</a></p></li><li><p>https://www.junmajinlong.com/linux/systemd/systemd_timer/</p></li></ol><p>执行文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=GLaDOS Checkin Service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/bin/docker compose -f /home/wf09/glados/docker-compose.yml up</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>timer触发器：以每天3点执行一次为例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=GLaDOS Checkin Timer</span><br><span class="line"></span><br><span class="line">[Timer]</span><br><span class="line">OnCalendar=*-*-* 03:00:00</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="bash-date日期时间">bash date日期时间</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">date</span> <span class="string">&#x27;+%Y-%m-%d %H:%M:%S&#x27;</span></span><br><span class="line">2021-08-17 22:49:57</span><br><span class="line"><span class="built_in">date</span> <span class="string">&#x27;+%Y-%m-%d&#x27;</span></span><br><span class="line">2021-08-17</span><br><span class="line"><span class="built_in">date</span> <span class="string">&#x27;+%Y%m%d&#x27;</span></span><br><span class="line">20210817</span><br><span class="line"><span class="built_in">date</span> +%Y%m%d</span><br><span class="line">20210817</span><br><span class="line"><span class="built_in">date</span> +%s</span><br><span class="line">1629211600</span><br></pre></td></tr></table></figure><h3 id="linux软连接">Linux软连接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s 源文件 目的文件</span><br></pre></td></tr></table></figure><h3 id="debian类修改源">debian类修改源</h3><h4 id="amd64">amd64</h4><h5 id="ubuntu">ubuntu</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&#x27;s/cn.archive.ubuntu.com/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apt/sources.list</span><br><span class="line">sudo sed -i <span class="string">&#x27;s/security.ubuntu.com/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apt/sources.list</span><br></pre></td></tr></table></figure><h5 id="debian">debian</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&#x27;s/deb.debian.org/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apt/sources.list</span><br><span class="line">sudo sed -i <span class="string">&#x27;s|security.debian.org/debian-security|mirrors.ustc.edu.cn/debian-security|g&#x27;</span> /etc/apt/sources.list</span><br></pre></td></tr></table></figure><h4 id="arm64">arm64</h4><h5 id="ubuntu-1">ubuntu</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&#x27;s/ports.ubuntu.com/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apt/sources.list</span><br><span class="line">sudo sed -i <span class="string">&#x27;s/ports.ubuntu.com/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apt/sources.list</span><br></pre></td></tr></table></figure><h4 id="树莓派">树莓派</h4><p>arm64架构的树莓派可以直接用debian的源 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br><span class="line"><span class="built_in">echo</span> &gt; /etc/apt/sources.list</span><br><span class="line">sudo vim /etc/apt/sources.list</span><br></pre></td></tr></table></figure> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">deb https://mirrors.ustc.edu.cn/debian/ bullseye main contrib non-free</span><br><span class="line"><span class="comment"># deb-src http://mirrors.ustc.edu.cn/debian bullseye main contrib non-free</span></span><br><span class="line">deb https://mirrors.ustc.edu.cn/debian/ bullseye-updates main contrib non-free</span><br><span class="line"><span class="comment"># deb-src http://mirrors.ustc.edu.cn/debian bullseye-updates main contrib non-free</span></span><br><span class="line">deb https://mirrors.ustc.edu.cn/debian-security bullseye-security main contrib non-free</span><br><span class="line"><span class="comment"># deb-src http://mirrors.ustc.edu.cn/debian-security/ bullseye-security main non-free contrib</span></span><br></pre></td></tr></table></figure>树莓派基金会源 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&#x27;s|//archive.raspberrypi.org|//mirrors.ustc.edu.cn/archive.raspberrypi.org|g&#x27;</span> /etc/apt/sources.list.d/raspi.list</span><br></pre></td></tr></table></figure> #### Docker</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -ex \ </span></span><br><span class="line">    &amp;&amp; sed -i <span class="string">&#x27;s/archive.ubuntu.com/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apt/sources.list \</span><br><span class="line">    &amp;&amp; sed -i <span class="string">&#x27;s/security.ubuntu.com/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apt/sources.list \</span><br><span class="line">    &amp;&amp; apt-get update \</span><br><span class="line">    &amp;&amp; apt-get install tzdata curl procps -y \</span><br><span class="line">    &amp;&amp; groupadd -g <span class="number">1000</span> admin -o -f \</span><br><span class="line">    &amp;&amp; useradd -m -G admin --uid <span class="number">1000</span> --gid <span class="number">1000</span> admin \</span><br><span class="line">    &amp;&amp; apt-get clean</span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /home/admin</span></span><br><span class="line"><span class="keyword">USER</span> admin</span><br></pre></td></tr></table></figure><h3 id="安装最新版nginx">安装最新版nginx</h3><h4 id="ubuntu-2">ubuntu</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install curl gnupg2 ca-certificates lsb-release ubuntu-keyring -y</span><br><span class="line">curl https://nginx.org/keys/nginx_signing.key | gpg --dearmor \</span><br><span class="line">    | sudo <span class="built_in">tee</span> /usr/share/keyrings/nginx-archive-keyring.gpg &gt;/dev/null</span><br><span class="line">gpg --dry-run --quiet --import --import-options import-show /usr/share/keyrings/nginx-archive-keyring.gpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># stable</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] \</span></span><br><span class="line"><span class="string">http://nginx.org/packages/ubuntu `lsb_release -cs` nginx&quot;</span> \</span><br><span class="line">    | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/nginx.list</span><br><span class="line"><span class="comment"># 优先级</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Package: *\nPin: origin nginx.org\nPin: release o=nginx\nPin-Priority: 900\n&quot;</span> \</span><br><span class="line">    | sudo <span class="built_in">tee</span> /etc/apt/preferences.d/99nginx</span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install nginx</span><br></pre></td></tr></table></figure><h4 id="debian-1">debian</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install curl gnupg2 ca-certificates lsb-release debian-archive-keyring -y</span><br><span class="line">curl https://nginx.org/keys/nginx_signing.key | gpg --dearmor \</span><br><span class="line">    | sudo <span class="built_in">tee</span> /usr/share/keyrings/nginx-archive-keyring.gpg &gt;/dev/null</span><br><span class="line">gpg --dry-run --quiet --import --import-options import-show /usr/share/keyrings/nginx-archive-keyring.gpg</span><br><span class="line"><span class="comment"># stable</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] \</span></span><br><span class="line"><span class="string">http://nginx.org/packages/debian `lsb_release -cs` nginx&quot;</span> \</span><br><span class="line">    | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/nginx.list</span><br><span class="line"><span class="comment"># 优先级</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Package: *\nPin: origin nginx.org\nPin: release o=nginx\nPin-Priority: 900\n&quot;</span> \</span><br><span class="line">    | sudo <span class="built_in">tee</span> /etc/apt/preferences.d/99nginx</span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install nginx</span><br></pre></td></tr></table></figure><h3 id="nginx基本配置">nginx基本配置</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line">  <span class="comment">#listen unix:/dev/shm/default.sock proxy_protocol;</span></span><br><span class="line">  <span class="comment">#listen unix:/dev/shm/h2c.sock http2 proxy_protocol;</span></span><br><span class="line">  <span class="attribute">listen</span> <span class="number">443</span> default_server ssl;</span><br><span class="line">  <span class="attribute">server_name</span> harbor.lo;</span><br><span class="line">  <span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">10m</span>;</span><br><span class="line">  <span class="attribute">ssl_certificate</span>     /home/ubuntu/.ssl/cert.cer;</span><br><span class="line">  <span class="attribute">ssl_certificate_key</span>  /home/ubuntu/.ssl/cert.key;</span><br><span class="line"></span><br><span class="line">  <span class="comment">#ssl_stapling on;</span></span><br><span class="line">  <span class="comment">#ssl_stapling_verify on;</span></span><br><span class="line"></span><br><span class="line">  <span class="attribute">ssl_session_timeout</span> <span class="number">10m</span>;</span><br><span class="line">  <span class="attribute">ssl_ciphers</span> HIGH:!aNULL:!MD5;</span><br><span class="line">  <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="comment">#proxy_redirect off;</span></span><br><span class="line">    <span class="comment">#proxy_pass https://wf09.github.io/;</span></span><br><span class="line">    <span class="comment">#alias /home/ubuntu/tmp/;</span></span><br><span class="line">    <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="gitlab配置">gitlab配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> server &#123;</span><br><span class="line">   charset utf-8;</span><br><span class="line">   <span class="comment">#listen unix:/dev/shm/default.sock proxy_protocol;</span></span><br><span class="line">   <span class="comment">#listen unix:/dev/shm/h2c.sock http2 proxy_protocol;</span></span><br><span class="line">   listen 443  ssl;</span><br><span class="line">   server_name gitlab.lo;</span><br><span class="line">   ssl_session_cache shared:SSL:10m;</span><br><span class="line">   ssl_certificate     /usr/local/ssl/gitlab.lo.crt;</span><br><span class="line">   ssl_certificate_key  /usr/local/ssl/gitlab.lo.key;</span><br><span class="line"></span><br><span class="line">   <span class="comment">#ssl_stapling on;</span></span><br><span class="line">   <span class="comment">#ssl_stapling_verify on;</span></span><br><span class="line"></span><br><span class="line">   ssl_session_timeout 10m;</span><br><span class="line">   ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class="line">   ssl_prefer_server_ciphers on;</span><br><span class="line">   ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;</span><br><span class="line"></span><br><span class="line">   location / &#123;</span><br><span class="line">     <span class="comment">#proxy_redirect off;</span></span><br><span class="line">     <span class="comment">#proxy_pass https://wf09.github.io/;</span></span><br><span class="line">     <span class="comment">#alias /home/ubuntu/tmp/;</span></span><br><span class="line">     <span class="comment">#return 403;</span></span><br><span class="line">     client_max_body_size 0;</span><br><span class="line">     proxy_pass http://192.168.15.200:8880;</span><br><span class="line">     proxy_set_header Host <span class="variable">$host</span>; <span class="comment"># required for docker client&#x27;s sake</span></span><br><span class="line">     proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>; <span class="comment"># pass on real client&#x27;s IP</span></span><br><span class="line">     proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">     proxy_set_header X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="其他配置">其他配置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span> auto;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">  <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">proxy_headers_hash_max_size</span> <span class="number">51200</span>;</span><br><span class="line">  <span class="attribute">proxy_headers_hash_bucket_size</span> <span class="number">6400</span>;</span><br><span class="line">  <span class="attribute">log_format</span> main <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &quot;<span class="variable">$request</span>&quot; &#x27;</span></span><br><span class="line">  <span class="string">&#x27;<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &quot;<span class="variable">$http_referer</span>&quot; &#x27;</span></span><br><span class="line">  <span class="string">&#x27;&quot;<span class="variable">$http_user_agent</span>&quot; &quot;<span class="variable">$http_x_forwarded_for</span>&quot; &#x27;</span></span><br><span class="line">  <span class="string">&#x27;<span class="variable">$proxy_protocol_addr</span>:<span class="variable">$proxy_protocol_port</span>&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">access_log</span> /var/log/nginx/access.log main;</span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">server_name</span> ap-sg-do.fly97.dev;</span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">10m</span>;</span><br><span class="line">    <span class="attribute">ssl_certificate</span>     /usr/local/bin/cert.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span>  /usr/local/bin/key.pem;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">      <span class="comment">#proxy_redirect off;</span></span><br><span class="line">      <span class="comment">#proxy_pass https://wf09.github.io/;</span></span><br><span class="line">      <span class="comment">#alias /home/ubuntu/tmp/;</span></span><br><span class="line">      <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span><span class="regexp"> ^~</span> /my/ &#123;</span><br><span class="line">      <span class="comment">#auth_basic &quot;Permission Denied&quot;;</span></span><br><span class="line">      <span class="comment">#auth_basic_user_file /usr/local/passwd;</span></span><br><span class="line">      <span class="attribute">alias</span> /mnt/volume_sgp1_01/;</span><br><span class="line">      <span class="attribute">autoindex</span> <span class="literal">on</span>;</span><br><span class="line">      <span class="attribute">proxy_force_ranges</span> <span class="literal">on</span>;</span><br><span class="line">      <span class="attribute">max_ranges</span> <span class="number">32</span>;</span><br><span class="line">      <span class="attribute">autoindex_exact_size</span> <span class="literal">off</span>;</span><br><span class="line">      <span class="attribute">add_header</span> Strict-Transport-Security <span class="string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> /qb/ &#123;</span><br><span class="line">      <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">      <span class="attribute">proxy_pass</span> http://127.0.0.1:8090/;</span><br><span class="line">      <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">      <span class="attribute">add_header</span> Strict-Transport-Security <span class="string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;</span><br><span class="line">      <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">      <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">      <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">      <span class="attribute">proxy_set_header</span> REMOTE-HOST <span class="variable">$remote_addr</span>;</span><br><span class="line">      <span class="attribute">proxy_set_header</span> Range <span class="variable">$http_range</span>;</span><br><span class="line">      <span class="attribute">proxy_set_header</span> If-Range <span class="variable">$http_if_range</span>;</span><br><span class="line">      <span class="attribute">proxy_no_cache</span> <span class="variable">$http_range</span> <span class="variable">$http_if_range</span>;</span><br><span class="line">      <span class="comment"># 如果server_name不是公网域名，这个地方可以设置成ip</span></span><br><span class="line">      <span class="attribute">proxy_set_header</span> X-Forwarded-Host <span class="variable">$host</span>;</span><br><span class="line">      <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">      <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">      <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;upgrade&quot;</span>;</span><br><span class="line">      <span class="attribute">http2_push_preload</span> <span class="literal">on</span>;</span><br><span class="line">      <span class="comment">#这个是设置为0表示不管上传多大的文件都不会报request too large的问题，直接转发过去</span></span><br><span class="line">      <span class="attribute">client_max_body_size</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="service模版">service模版</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">Unit</span>]</span><br><span class="line"><span class="string">Description=Lightweight</span> <span class="string">Kubernetes</span></span><br><span class="line"><span class="string">Documentation=https://k3s.io</span></span><br><span class="line"><span class="string">Wants=network-online.target</span></span><br><span class="line"><span class="string">After=network-online.target</span></span><br><span class="line"></span><br><span class="line">[<span class="string">Install</span>]</span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"></span><br><span class="line">[<span class="string">Service</span>]</span><br><span class="line"><span class="string">Type=notify</span></span><br><span class="line"><span class="string">EnvironmentFile=-/etc/default/%N</span></span><br><span class="line"><span class="string">EnvironmentFile=-/etc/sysconfig/%N</span></span><br><span class="line"><span class="string">EnvironmentFile=-/etc/systemd/system/k3s.service.env</span></span><br><span class="line"><span class="string">KillMode=process</span></span><br><span class="line"><span class="string">Delegate=yes</span></span><br><span class="line"><span class="comment"># Having non-zero Limit*s causes performance problems due to accounting overhead</span></span><br><span class="line"><span class="comment"># in the kernel. We recommend using cgroups to do container-local accounting.</span></span><br><span class="line"><span class="string">LimitNOFILE=1048576</span></span><br><span class="line"><span class="string">LimitNPROC=infinity</span></span><br><span class="line"><span class="string">LimitCORE=infinity</span></span><br><span class="line"><span class="string">TasksMax=infinity</span></span><br><span class="line"><span class="string">TimeoutStartSec=0</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string">RestartSec=5s</span></span><br><span class="line"><span class="string">ExecStartPre=/bin/sh</span> <span class="string">-xc</span> <span class="string">&#x27;! /usr/bin/systemctl is-enabled --quiet nm-cloud-setup.service&#x27;</span></span><br><span class="line"><span class="string">ExecStartPre=-/sbin/modprobe</span> <span class="string">br_netfilter</span></span><br><span class="line"><span class="string">ExecStartPre=-/sbin/modprobe</span> <span class="string">overlay</span></span><br><span class="line"><span class="string">ExecStart=/usr/local/bin/k3s</span> <span class="string">server</span> <span class="string">--node-ip</span> <span class="number">192.168</span><span class="number">.7</span><span class="number">.2</span> <span class="string">--node-external-ip</span> <span class="number">192.168</span><span class="number">.15</span><span class="number">.201</span> <span class="string">--tls-san</span> <span class="number">192.168</span><span class="number">.7</span><span class="number">.2</span> <span class="string">--flannel-backend</span> <span class="string">host-gw</span> <span class="string">--flannel-iface</span> <span class="string">wg0</span> <span class="string">--no-deploy</span> <span class="string">servicelb</span> <span class="string">--write-kubeconfig-mode</span> <span class="number">644</span> <span class="string">--kube-proxy-arg</span> <span class="string">&#x27;proxy-mode=ipvs&#x27;</span> <span class="string">--kube-proxy-arg</span> <span class="string">&#x27;ipvs-scheduler=rr&#x27;</span> <span class="string">--kube-proxy-arg</span> <span class="string">&#x27;masquerade-all=true&#x27;</span> <span class="string">--kube-proxy-arg</span> <span class="string">&#x27;metrics-bind-address=0.0.0.0:10249&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="docker-compose常用配置">docker-compose常用配置</h3><h4 id="node-exporter">node exporter</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">        <span class="attr">node_exporter:</span></span><br><span class="line">                <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">                <span class="attr">image:</span> <span class="string">prom/node-exporter</span></span><br><span class="line">                <span class="attr">volumes:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">/run:/run</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">/proc:/host/proc:ro</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">/sys:/host/sys:ro</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">/:/rootfs:ro</span></span><br><span class="line">                <span class="attr">command:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">&quot;--web.listen-address=:9100&quot;</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">&quot;--path.procfs=/host/proc&quot;</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">&quot;--path.sysfs=/host/sys&quot;</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">&quot;--path.rootfs=/rootfs&quot;</span> <span class="comment"># Necessary for collecting host filesystem metrics.</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">&quot;--collector.filesystem.ignored-mount-points=&#x27;^/(sys|proc|dev|host|etc|rootfs/var/lib/docker/containers|rootfs/var/lib/docker/overlay2|rootfs/run/docker/netns|rootfs/var/lib/docker/aufs)($$|/)&#x27;&quot;</span></span><br><span class="line">                <span class="attr">ports:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="number">9100</span><span class="string">:9100</span></span><br><span class="line">                <span class="attr">restart:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure><h4 id="普罗米修斯">普罗米修斯</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">        <span class="attr">prometheus:</span></span><br><span class="line">                <span class="attr">image:</span> <span class="string">prom/prometheus</span></span><br><span class="line">                <span class="attr">ports:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="number">9091</span><span class="string">:9090</span></span><br><span class="line">                <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">                <span class="attr">volumes:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">./conf:/etc/prometheus</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">./data:/prometheus</span></span><br></pre></td></tr></table></figure><h4 id="grafana">grafana</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">        <span class="attr">grafana:</span></span><br><span class="line">                <span class="attr">image:</span> <span class="string">grafana/grafana:9.3.1-ubuntu</span></span><br><span class="line">                <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">                <span class="attr">volumes:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">./sample.ini:/etc/grafana/grafana.ini</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">./data:/var/lib/grafana</span></span><br><span class="line">                <span class="attr">ports:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="number">3000</span><span class="string">:3000</span></span><br></pre></td></tr></table></figure><h4 id="alertmanager">alertManager</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">        <span class="attr">alert:</span></span><br><span class="line">                <span class="attr">image:</span> <span class="string">prom/alertmanager</span></span><br><span class="line">                <span class="attr">ports:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="number">9093</span><span class="string">:9093</span></span><br><span class="line">                <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">                <span class="attr">volumes:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">./conf:/etc/alertmanager</span></span><br></pre></td></tr></table></figure><h4 id="jenkins">jenkins</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.6&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">jenkins:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&#x27;jenkins/jenkins&#x27;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">jenkins</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="comment"># hostname: &#x27;gitlab.lo&#x27;                          # ssh hostname</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;127.0.0.1:8882:8080&#x27;</span></span><br><span class="line">    <span class="attr">shm_size:</span> <span class="string">&#x27;256m&#x27;</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="attr">nofile:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">1000000</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">1000000</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">8G</span></span><br></pre></td></tr></table></figure><h4 id="gitlab">gitlab</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.6&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">gitlab:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&#x27;registry.gitlab.cn/omnibus/gitlab-jh:latest&#x27;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">gitlab-cn</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">&#x27;gitlab.lo&#x27;</span>                          <span class="comment"># ssh hostname</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">       <span class="attr">GITLAB_OMNIBUS_CONFIG:</span> <span class="string">|</span></span><br><span class="line"><span class="string">         external_url &#x27;https://gitlab.lo&#x27;          # git httpsname</span></span><br><span class="line"><span class="string">         nginx[&#x27;redirect_http_to_https&#x27;] = false</span></span><br><span class="line"><span class="string">         nginx[&#x27;listen_port&#x27;] = 8880</span></span><br><span class="line"><span class="string">         nginx[&#x27;listen_https&#x27;] = false</span></span><br><span class="line"><span class="string">         prometheus_monitoring[&#x27;enable&#x27;] = false</span></span><br><span class="line"><span class="string"></span>    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;127.0.0.1:8881:8880&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;22:22&#x27;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;./config:/etc/gitlab&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;./logs:/var/log/gitlab&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;./data:/var/opt/gitlab&#x27;</span></span><br><span class="line">    <span class="attr">shm_size:</span> <span class="string">&#x27;256m&#x27;</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">8G</span></span><br></pre></td></tr></table></figure><h3 id="mysql备份脚本">MySQL备份脚本</h3><p>将MySQL文件逻辑备份文件以Docker镜像的形式推送到Docker私有镜像服务器</p><h4 id="bash脚本">bash脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">day=`<span class="built_in">date</span> <span class="string">&quot;+%Y%m%d&quot;</span>`</span><br><span class="line"><span class="built_in">cd</span> $(<span class="built_in">dirname</span> $(<span class="built_in">readlink</span> -f <span class="string">&quot;<span class="variable">$0</span>&quot;</span>))/data</span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$day</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$day</span></span><br><span class="line">mysqldump -h192.168.31.28 -uroot -proot -A | gzip &gt; <span class="variable">$day</span>.tar.gz</span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span> </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;MySQL备份失败&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> -1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;FROM busybox\nADD <span class="variable">$day</span>.tar.gz /mysql/<span class="variable">$day</span>.tar.gz&quot;</span> &gt; Dockerfile</span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span> </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Dockerfile生成失败&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> -1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">[ -f Dockerfile ] &amp;&amp; docker build . -t hub.deepsoft-tech.com/wf09/jixiaobackup:<span class="variable">$day</span></span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span> </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;镜像生成构建失败&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> -1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">docker login -uadmin -pdeepsoft hub.deepsoft-tech.com</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span> </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;登录成功&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> -1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">docker push hub.deepsoft-tech.com/wf09/jixiaobackup:<span class="variable">$day</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span> </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;带TAG的镜像推送失败&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> -1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">docker tag hub.deepsoft-tech.com/wf09/jixiaobackup:<span class="variable">$day</span> hub.deepsoft-tech.com/wf09/mysqlbackup</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span> </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;镜像推送失败&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> -1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><h4 id="service单元文件">service单元文件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Backup MySQL Service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/bin/bash -c /home/deepsoft/backup/mysql/backup.sh </span><br><span class="line">StandardError=journal</span><br></pre></td></tr></table></figure><h4 id="timer单元文件">timer单元文件</h4><p>每周备份两次</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Backup MySQL Timer</span><br><span class="line"></span><br><span class="line">[Timer]</span><br><span class="line">OnCalendar=Sun,Wed 03:30:00</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;关键词：&lt;strong&gt;运维操作&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="运维" scheme="https://fly97.cn/tags/%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>树莓派常见操作</title>
    <link href="https://fly97.cn/p/use-usb-wifi-with-raspberry-pi/"/>
    <id>https://fly97.cn/p/use-usb-wifi-with-raspberry-pi/</id>
    <published>2022-12-01T12:00:00.000Z</published>
    <updated>2022-12-01T12:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要：本文主要介绍树莓派的一些常见设置。</strong></p><p><strong>关键词：树莓派</strong></p><span id="more"></span><h2 id="安装外置usb网卡">安装外置USB网卡</h2><p>由于树莓派自带的网卡性能不太好，因此就想着用第三方网卡。使用的网卡如图所示。 <img data-src="微信图片_20221211193757.jpg" /></p><p>网卡芯片型号是Realtek 8211CU。</p><blockquote><p>来源 https://github.com/brektrou/rtl8821CU/issues/184</p></blockquote><p>依次执行以下操作即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install dkms bc -y</span><br><span class="line">sudo apt-get update &amp;&amp; sudo apt-get install --reinstall raspberrypi-bootloader raspberrypi-kernel</span><br><span class="line">sudo apt-get install raspberrypi-kernel-headers</span><br><span class="line">reboot</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/brektrou/rtl8821CU.git</span><br><span class="line"><span class="built_in">cd</span> rtl8821CU</span><br><span class="line">sudo ./dkms-install.sh</span><br></pre></td></tr></table></figure><p>执行完毕以后可以修改一下系统配置，这样系统就可以自动启动WIFI网卡了。</p><p>修改一下文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /lib/udev/rules.d/40-usb_modeswitch.rules</span><br></pre></td></tr></table></figure><p>添加以下内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Realtek 8211CU Wifi AC USB</span></span><br><span class="line">ATTR&#123;idVendor&#125;==<span class="string">&quot;0bda&quot;</span>, ATTR&#123;idProduct&#125;==<span class="string">&quot;1a2b&quot;</span>, RUN+=<span class="string">&quot;/usr/sbin/usb_modeswitch -K -v 0bda -p 1a2b&quot;</span></span><br></pre></td></tr></table></figure><p>然后重启即可</p><p>重启完毕以后查看usb：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsusb</span><br></pre></td></tr></table></figure><p><img data-src="Snipaste_2022-12-11_19-52-59.png" />此时就可以发现网卡已经正常工作了。</p><h2 id="禁用板载wifi">禁用板载WIFI</h2><p>修改boot分区下的config.txt文件</p><p>在<code>[all]</code>片段下添加以下配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[all]</span><br><span class="line">dtoverlay=disable-wifi</span><br></pre></td></tr></table></figure><p>这样就可以禁用板载WIFI网卡</p><h2 id="开启wifi自动登录">开启WIFI自动登录</h2><p>在boot分区下添加<code>wpa_supplicant.conf</code>文件</p><p>按照以下格式：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">country</span>=CN</span><br><span class="line"><span class="attr">ctrl_interface</span>=DIR=/var/run/wpa_supplicant GROUP=netdev</span><br><span class="line"><span class="attr">update_config</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">network</span>=&#123;</span><br><span class="line"><span class="attr">ssid</span>=<span class="string">&quot;WiFi-A&quot;</span></span><br><span class="line"><span class="attr">psk</span>=<span class="string">&quot;12345678&quot;</span></span><br><span class="line"><span class="attr">key_mgmt</span>=WPA-PSK</span><br><span class="line"><span class="attr">priority</span>=<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="开启ssh登录">开启SSH登录</h2><p>在boot分区下新建<code>ssh</code>文件即可</p><h2 id="更换为国内源">更换为国内源</h2><p>arm64架构的树莓派可以直接用debian的源</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br><span class="line"><span class="built_in">echo</span> &gt; /etc/apt/sources.list</span><br><span class="line">sudo vim /etc/apt/sources.list</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">deb https://mirrors.ustc.edu.cn/debian/ bullseye main contrib non-free</span><br><span class="line"><span class="comment"># deb-src http://mirrors.ustc.edu.cn/debian bullseye main contrib non-free</span></span><br><span class="line">deb https://mirrors.ustc.edu.cn/debian/ bullseye-updates main contrib non-free</span><br><span class="line"><span class="comment"># deb-src http://mirrors.ustc.edu.cn/debian bullseye-updates main contrib non-free</span></span><br><span class="line">deb https://mirrors.ustc.edu.cn/debian-security bullseye-security main contrib non-free</span><br><span class="line"><span class="comment"># deb-src http://mirrors.ustc.edu.cn/debian-security/ bullseye-security main non-free contrib</span></span><br></pre></td></tr></table></figure><p>树莓派基金会源</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&#x27;s|//archive.raspberrypi.org|//mirrors.ustc.edu.cn/archive.raspberrypi.org|g&#x27;</span> /etc/apt/sources.list.d/raspi.list</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;strong&gt;摘要：本文主要介绍树莓派的一些常见设置。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;关键词：树莓派&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="pi" scheme="https://fly97.cn/tags/pi/"/>
    
  </entry>
  
  <entry>
    <title>DevOps实战（二）使用Docker搭建nexus3私有镜像仓库</title>
    <link href="https://fly97.cn/p/install-nexus3-with-docker/"/>
    <id>https://fly97.cn/p/install-nexus3-with-docker/</id>
    <published>2022-11-09T06:00:00.000Z</published>
    <updated>2022-11-09T06:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>什么是DevOps？</p><p>DevOps的哲学暂且不表，使用Docker搭建nexus3私有镜像仓库。</p><p>关键词：<strong>nexus3</strong></p><span id="more"></span><h2 id="前言">前言</h2><p>在搭建K8s容器平台时，有些镜像需要经常性的被拉取，有时候外网带宽会被大量占用，这在业务上线后是不可取的，为了方便镜像的拉取，私有仓库的概念应运而生。</p><p>本文主要介绍使用nexus3搭建私有仓库。</p><h2 id="安装">安装</h2><p>为了方便起见我们这里直接使用Docker进行快速搭建。</p><p>为节省时间，我们这里先拉取好了镜像：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.6&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nexus3:</span></span><br><span class="line">    <span class="comment">#user: root</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">sonatype/nexus3</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nexus3</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https_proxy=http://192.168.31.75:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">http_proxy=http://192.168.31.75:7890</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nexus-data:/nexus-data</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="attr">nofile:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">1000000</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">1000000</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">38081</span><span class="string">:8081</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7890</span><span class="string">:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7891</span><span class="string">:7891</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8891</span><span class="string">:8891</span></span><br></pre></td></tr></table></figure><p>这里的端口分别是nexus3界面的端口，和。。。。。。。 ##设置代理类型</p><p>Nexus3可以被称为是一个全能型的选手，可以代理几乎所有类型的仓库。</p><p><img data-src="image-20221109103319038.png" /></p><p>这里介绍几种类型，首先介绍Docker</p><h3 id="docker">docker</h3><p>docker类型分为docker(group)、docker(hosted)、docker(proxy)三种类型。</p><p>docker(proxy)：顾名思义就是代理外部仓库，创建设置可以参考以下</p><p><img data-src="image-20221109111325590.png" /></p><ul><li>这里的HTTP连接器不用选，因为我们后面会通过docker(group)类型聚合这docker(hosted)、docker(proxy)这两种类型的仓库。</li><li>远程仓库地址可以使用公开的镜像源，如：<ul><li>https://hub-mirror.c.163.com</li><li>https://mirror.baidubce.com</li><li>http://f1361db2.m.daocloud.io</li><li>https://ustc-edu-cn.mirror.aliyuncs.com</li></ul></li><li>如果网络条件允许，最好还是使用官方的源：<code>https://registry-1.docker.io</code>，这样会避免由于镜像不更新而导致的错误。</li></ul><p>docker(hosted)：允许将本地镜像推送到私有仓库的仓库类型，创建设置可以参考以下</p><p><img data-src="image-20221109111712080.png" /></p><ul><li>这里需要选择HTTP连接器，我们通过此HTTP连接器向仓库推送本地镜像</li></ul><p>docker(group)：将两者类型或者更多种类型的仓库聚合在一起，一起向外部提供服务</p><p><img data-src="image-20221109133813885.png" /></p><p><img data-src="image-20221109133917141.png" /></p><ul><li>这里需要选择HTTP连接器，我们通过此HTTP连接器拉取proxy代理的镜像和经过hosted上传的镜像；</li><li>这里选择的聚合仓库包含proxy和hosted类型的仓库，我们就可以通过此聚合仓库上传和下载镜像了；</li></ul><h4 id="nginx代理">Nginx代理</h4><p>因为某些原因，我们需要使用nginx反向代理，这里给出使用SSL证书的例子：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> hub.deepsoft-tech.com;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_tokens</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">server_name</span> hub.deepsoft-tech.com;</span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">10m</span>;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> /ssl/idocker.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /ssl/idocker.key;</span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/docker.io.log main;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">chunked_transfer_encoding</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">10m</span>;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">10m</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> HIGH:!aNULL:!MD5;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> <span class="regexp">~ ^/(v1|v2)/[^/]+/?[^/]+/blobs/</span> &#123;</span><br><span class="line">        <span class="attribute">if</span> (<span class="variable">$request_method</span> <span class="regexp">~* (POST|PUT|DELETE|PATCH|HEAD)</span> ) &#123;</span><br><span class="line">            <span class="attribute">rewrite</span><span class="regexp"> ^/(.*)$</span> /repository/docker-local/<span class="variable">$1</span> <span class="literal">last</span>;   <span class="comment"># docker-local是hosted类型的仓库名称</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/(.*)$</span> /repository/docker/<span class="variable">$1</span> <span class="literal">last</span>;             <span class="comment"># docker是group类型的仓库名称</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> <span class="regexp">~ ^/(v1|v2)/</span> &#123;</span><br><span class="line">        <span class="attribute">if</span> (<span class="variable">$request_method</span> <span class="regexp">~* (POST|PUT|DELETE|PATCH)</span> ) &#123;</span><br><span class="line">            <span class="attribute">rewrite</span><span class="regexp"> ^/(.*)$</span> /repository/docker-local/<span class="variable">$1</span> <span class="literal">last</span>;  <span class="comment"># docker-local是hosted类型的仓库名称</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/(.*)$</span> /repository/docker/<span class="variable">$1</span> <span class="literal">last</span>;            <span class="comment"># docker是group类型的仓库名称</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:38081/;                   <span class="comment"># 38081是nexus对外暴露的端口</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span> <span class="number">3600</span>;</span><br><span class="line">        <span class="attribute">proxy_send_timeout</span> <span class="number">3600</span>;</span><br><span class="line">        <span class="attribute">proxy_read_timeout</span> <span class="number">3600</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_buffering</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_request_buffering</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>这么看，hosted类型和group类型的仓库就不需要设置HTTP连接器了；</li><li>经过以上设置，推送请求就全部被hosted类型的仓库接管了，而拉取请求则被group类型的仓库接管了；</li></ul><p>经过上面的一顿操作，就可以通过一个URL拉取所有的镜像了</p><h3 id="apt仓库">APT仓库</h3><p>有时候需要缓存apt的包，所有就有了下面的文章，幸运的是nexus支持apt类型，稍加设置即可</p><p><img data-src="image-20221109152407070.png" /></p><ul><li>Distribution：发行版的代号，这里以Ubuntu LTS 20.04 为例：focal</li><li>Remote storage：代理仓库地址，可以使用镜像源</li></ul><h4 id="nginx代理-1">Nginx代理</h4><p>使用上文的配置文件即可</p><h4 id="一键替换">一键替换</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&#x27;s|http://mirrors.aliyun.com|https://repo.deepsoft-tech.com/repository|g&#x27;</span> /etc/apt/sources.list</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&#x27;s|https://mirrors.aliyun.com/docker-ce/linux/ubuntu|https://repo.deepsoft-tech.com/repository/docker-apt&#x27;</span> /etc/apt/sources.list.d/docker.list</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;什么是DevOps？&lt;/p&gt;
&lt;p&gt;DevOps的哲学暂且不表，使用Docker搭建nexus3私有镜像仓库。&lt;/p&gt;
&lt;p&gt;关键词：&lt;strong&gt;nexus3&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="devops" scheme="https://fly97.cn/tags/devops/"/>
    
    <category term="nexus3" scheme="https://fly97.cn/tags/nexus3/"/>
    
  </entry>
  
  <entry>
    <title>Go语言基础（三）输入输出接口</title>
    <link href="https://fly97.cn/p/input-output-interface/"/>
    <id>https://fly97.cn/p/input-output-interface/</id>
    <published>2022-10-28T09:26:00.000Z</published>
    <updated>2022-10-28T09:26:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要介绍了Go语言输入输出接口。</p><p>关键词：<strong>golang</strong></p><span id="more"></span><h1 id="基本的io接口">基本的IO接口</h1><h2 id="reader接口">Reader接口</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</span><br><span class="line">    Read(p []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>将len(p)个字节读入到p中，返回读取的字节数n以及任何的错误。即使Read返回的n&lt;len(p)，他也会在调用过程中占用len(p)个字节作为暂存空间。若可读取的数据不到len(p)个字节，会返回可用数据，而不是等待更多数据。</p><p>当Read在成功读取n个字节后，遇到一个错误或者EOF，会返回读取的字节数，可能会在本次的调用中返回一个non-nil错误，或者在下一次调用中返回这个错误（n为0）。一般情况下，Reader会返回非0字节数n，若n=len(p)个字节从输入源内的结尾处由Read返回，Read可能返回err==EOF或者err==nil，并且之后的Read()都应该返回(n:0,err:EOF).</p><p>调用者在考虑错误之前应当首先处理返回的数据。这样做可以正确的处理在读取一些字节后产生的I/O，允许EOF出现。</p></blockquote><p>Reader的接口方法集只包含一个Read方法，实现了Read方法的类型都满足io.Reader接口，也就是说在需要io.Reader的地方，可以传递实现了Read()方法的实例。</p><p>举例说明Reader接口的方法：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadFrom</span><span class="params">(reader io.Reader, num <span class="type">int</span>)</span></span>([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    p := <span class="built_in">make</span>([]<span class="type">byte</span>, num)</span><br><span class="line">    n, err := reader.Read(p)</span><br><span class="line">    <span class="keyword">if</span> n &gt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> p[:n], <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> p, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ReadFrom函数将io.Reader作为参数，ReadForm可以从任意的地方读取数据，只要来源实现了io.Reader接口。可以从标准输入、文件、字符串读取数据：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 标准输入</span><br><span class="line">data, err = ReadFrom(os.Stdin, 11)</span><br><span class="line">// 普通文件读取，其中file是os.File的实例</span><br><span class="line">data, err = ReadFrom(file, 9)</span><br><span class="line">// 从字符串读取</span><br><span class="line">data, err = ReadFrom(strings.NewReader(&quot;form string&quot;), 12)</span><br></pre></td></tr></table></figure><h2 id="writer-接口">Writer 接口</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</span><br><span class="line">    Wirte(p []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>将len(p)个字节写入基本数据流中，返回从p中被写入的字节数n，以及任何遇到的引起的提前停止的错误。若Write返回的n&lt;len(p)，就必须返回一个非nil的错误。</p></blockquote><p>所有实现了Write方法的类型都实现了io.Writer接口。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Println</span><span class="params">(a ...<span class="keyword">interface</span>&#123;&#125;)</span></span>(n <span class="type">int</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> Fprintln(os.Stdout, a...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2id="实现了reader接口或者writer接口的类型">实现了Reader接口或者Writer接口的类型</h2><ul><li>os.File同时实现了io.Reader和io.Writer</li><li>strings.Reader实现了io.Reader</li><li>bufio.Reader/Writer 分别实现了 io.Reader 和 io.Writer</li><li>bytes.Buffer同时实现了io.Reader和io.Writer</li><li>bytes.Reader实现了io.Reader</li><li>compress/gzip.Reader/Writer 分别实现了io.Reader和io.Writer</li><li>crypto/cipher.StreamReader/StreamWriter 分别实现了 io.Reader 和io.Writer</li><li>crypto/tls.Conn同时实现了io.Reader和io.Writer</li><li>encoding/csv.Reader/Writer 分别实现了 io.Reader 和 io.Writer</li><li>mine/multpart.Part实现了io.Reader</li><li>net/conn分别实现了io.Reader和io.Writer（Conn接口定义了Read/Write）</li></ul><h2 id="closer接口">Closer接口</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Closer <span class="keyword">interface</span> &#123;</span><br><span class="line">    Close() <span class="type">error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该接口比较简单，只有一个close()方法，用于关闭数据流；</p><p>文件、归档、数据库链接、Socket等需要手动关闭的资源都实现了Closer接口；</p><p>实际编程中通常将Close方法的调用放在defer语句中。</p><h1 id="ioutil-方便的io操作函数集">ioutil 方便的IO操作函数集</h1><h2 id="nopcloser函数">NopCloser函数</h2><p>有时候我们需要传递一个io.ReadCloser实例，而我们现在有一个io.Reader实例。</p><p>使用NopCloser包装一个Reader，返回一个io.ReaderCloser，相应的Close方法什么也不做，只是返回nil；</p><p>比如在标准库net/http包中的NewRequest，接收一个io.Reader的body，实际上Request的Body的类型是io.ReadCloser，因此代码内部做了判断：</p><p>如果传入的io.Reader也实现了io.ReaderCloser接口，则转换，否则通过ioutil.NopCloser包装一下。</p><h2 id="readall函数">ReadAll函数</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadAll</span><span class="params">(r io.Reader)</span></span>([]<span class="type">byte</span>, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>一次性读取io.Reader中的所有数据</p><h2 id="readdir函数">ReadDir函数</h2><p>输出某目录下面的所有文件（包括子目录）</p><h2 id="readfile和writefile函数">ReadFile和WriteFile函数</h2><p>ReadFile读取整个文件的内容。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadFile</span><span class="params">(filename <span class="type">string</span>)</span></span>([]<span class="type">byte</span>, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><blockquote><p>从指定的filename的文件中读取数据并返回文件的内容，成功的调用返回的err为nil而非EOF。因为本函数定义为读取整个文件不会将读取的EOF视为报告的错误</p></blockquote><p>WriteFile将data写入filename文件中，当文件不存在时会根据perm指定的权限创建一个，文件存在时会先清空内容，对于perm参数，可以指定为0666.</p><h2 id="tempdir和tempfile函数">TempDir和TempFile函数</h2><p>一般操作系统都会允许创建临时目录，比如linux下的/tmp目录。</p><p>通过TempDir可以创建一个临时目录，用于存放编译过程的临时目录</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b.work, err = ioutil.TempDir(<span class="string">&quot;&quot;</span>, <span class="string">&quot;tmp&quot;</span>)</span><br></pre></td></tr></table></figure><p>如果第一个参数为空，表面在系统默认的临时目录中创建临时目录，第二个参数指定临时目录的前缀，函数返回临时目录的路径；</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f1, err := ioutil.TempFile(<span class="string">&quot;&quot;</span>, <span class="string">&quot;gofmt&quot;</span>)</span><br></pre></td></tr></table></figure><p>创建者创建的临时变量和临时目录要负责删除这些临时目录和文件，比如删除临时文件：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    f.<span class="built_in">close</span>()</span><br><span class="line">    os.Remove(f.Name())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文主要介绍了Go语言输入输出接口。&lt;/p&gt;
&lt;p&gt;关键词：&lt;strong&gt;golang&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="golang" scheme="https://fly97.cn/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes集群实践（十二）如何恢复etcd集群并重建k3s集群</title>
    <link href="https://fly97.cn/p/restoring-etcd-cluster/"/>
    <id>https://fly97.cn/p/restoring-etcd-cluster/</id>
    <published>2022-09-17T06:38:00.000Z</published>
    <updated>2022-09-17T06:38:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要介绍在etcd集群崩溃时如何恢复。</p><p>关键词：<strong>k8s</strong></p><span id="more"></span><h2 id="背景">背景</h2><p>本人在实习公司主要负责管理k8s集群工作。使用的发行版是v1.24.3+k3s1。</p><p>为什么使用k3s呢，主要因为这个搭建比较方便，只需要一个二进制文件就可以起来一个集群。</p><p>在搭建集群的时候，考虑要保证集群高可用，因此使用了官网提供的<strong><ahref="https://docs.rancher.cn/docs/k3s/installation/ha-embedded/_index/">嵌入式DB的高可用| Rancher文档</a></strong>方案。</p><p>网站上写了<strong>需要奇数的 server节点，并且建议从三个节点开始</strong>。</p><p>因为我们现在管理的集群比较小，因此就<strong>使用了两个节点作为server节点</strong>。<strong>这为下文集群出现故障埋下了伏笔。</strong></p><p>⚠<strong>etcd 为了避免脑裂，采用了 raft算法，规定只有过半数节点在线才能提供服务，即 N/2+1 节点在线才能选出Leader。即如果有一个server挂了，那么集群就挂掉了！！</strong></p><p>因为某些原因，我将集群中的一个server踢出了集群，此时集群就不可用了。具体表现为：</p><p>在master节点上执行<code>kubectl get node</code>无法正常回显。</p><p>于是就有了本文。</p><h2 id="etcd集群恢复">etcd集群恢复</h2><p>当集群超过半数节点宕机，此时集群出于无法正常工作的状态，需要尽快恢复。</p><p>若机器宕机重启，IP保持不变，则证书无需重新生成；若IP更换，则还需要重新生成证书。</p><p>集群恢复还需要生成etcd的备份数据：使用<code>etcdctl snapshot save</code>命令备份或者从etcd数据目录复制<code>snap/db</code>文件。</p><h3 id="将备份数据恢复至集群">将备份数据恢复至集群</h3><p>首先明确k3s内置的etcd数据在<code>/var/lib/rancher/k3s/server/db/etcd</code>这个目录；</p><p>和etcd相关的证书在<code>/var/lib/rancher/k3s/server/tls/etcd</code>这个目录；</p><p>etcd配置文件在<code>/var/lib/rancher/k3s/server/db/etcd/config</code>这个文件。</p><p>以下操作都是在matser节点上执行的</p><ol type="1"><li><p>将k3s相关服务先关闭</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop k3s</span><br></pre></td></tr></table></figure></li><li><p>安装一个etcd集群</p><p>这里为了简化操作，使用一个etcd服务端代替集群。</p><p>这里配置文件大部分还是使用原来k3s集群的配置文件，将数据的保存路径修改一下，安装完毕以后，将原有的etcd目录删除，然后启动etcd服务。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo etcd --config-file /newpath/etcd/config</span><br></pre></td></tr></table></figure></li><li><p>使用etcd客户端执行恢复etcd数据命令，这里的证书还是原来k3s集群使用的证书</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo etcdctl --endpoints=https://x.x.x.x:2379 --cert=client.crt --key=client.key --cacert=server-ca.crt --data-dir=/newpath/etcd/data snapshot restore snap/db</span><br></pre></td></tr></table></figure></li><li><p>修改k3s服务端相关配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ExecStart=/usr/local/bin/k3s \</span><br><span class="line">    server \</span><br><span class="line">        <span class="string">&#x27;--disable=metrics-server&#x27;</span> \</span><br><span class="line">        <span class="string">&#x27;--flannel-backend=host-gw&#x27;</span> \</span><br><span class="line">        <span class="string">&#x27;--write-kubeconfig-mode=644&#x27;</span> \</span><br><span class="line">        <span class="string">&#x27;--datastore-endpoint=https://192.168.31.29:2379&#x27;</span> \</span><br><span class="line">        <span class="string">&#x27;--datastore-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt&#x27;</span> \</span><br><span class="line">        <span class="string">&#x27;--datastore-certfile=/var/lib/rancher/k3s/server/tls/etcd/server-client.crt&#x27;</span> \</span><br><span class="line">        <span class="string">&#x27;--datastore-keyfile=/var/lib/rancher/k3s/server/tls/etcd/server-client.key&#x27;</span> \</span><br><span class="line">        <span class="string">&#x27;--bind-address=192.168.31.29&#x27;</span> \</span><br><span class="line">        <span class="string">&#x27;--kube-scheduler-arg=&#x27;</span>config=/usr/local/etc/scheduler-policy-config.yaml<span class="string">&#x27;&#x27;</span> \</span><br></pre></td></tr></table></figure></li><li><p>重启k3s服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart k3s</span><br></pre></td></tr></table></figure><p>此时k3s服务应该可以正常启动了，但是还会有些问题，如原来删除的节点的一些信息还存在etcd集群中，但是k3sapiserver中不存在相应的数据，此时只能执行强制删除操作。</p><p>在master节点上执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete xxx --force --grace-period=0</span><br></pre></td></tr></table></figure></li></ol><p>​ 其中xxx代之相应的资源</p><ol start="6" type="1"><li><p>如果还出现异常的话，需要链接到etcd服务端，直接执行删除操作：</p><p>先查找所有的etcd对象</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl.exe --cacert=certs\server-ca.crt --cert=certs\client.crt --key=certs\client.key --endpoints=https://192.168.31.29:2379 get <span class="string">&quot;&quot;</span>  --prefix --keys-only</span><br></pre></td></tr></table></figure><p>然后删除和master节点有关的信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl.exe --cacert=certs\server-ca.crt --cert=certs\client.crt --key=certs\client.key --endpoints=https://192.168.31.29:2379 del /registry/csinodes/pve-master</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl.exe --cacert=certs\server-ca.crt --cert=certs\client.crt --key=certs\client.key --endpoints=https://192.168.31.29:2379 del /registry/csinodes/pve-master</span><br></pre></td></tr></table></figure></li></ol><p>完。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文主要介绍在etcd集群崩溃时如何恢复。&lt;/p&gt;
&lt;p&gt;关键词：&lt;strong&gt;k8s&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="k8s" scheme="https://fly97.cn/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>运维开发（一）MySQL备份</title>
    <link href="https://fly97.cn/p/MySQL-backup/"/>
    <id>https://fly97.cn/p/MySQL-backup/</id>
    <published>2022-09-07T06:10:00.000Z</published>
    <updated>2022-09-07T06:10:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要介绍MySQL备份。</p><p>关键词：<strong>MySQL</strong></p><span id="more"></span><h2 id="逻辑备份">逻辑备份</h2><p>数据库对象级备份，备份内容是表、索引、存储过程等数据库对象，常见工具为MySQLmysqldump、Oracle exp/imp等。</p><p>逻辑备份备份速度较慢，恢复速度较慢，体积较大，需要数据库正常运行才可以执行逻辑备份。</p><p>优点是备份级别可控，即可以任意选择备份的数据库或者备份的表。</p><p>逻辑备份适用于任何存储引擎，一般使用<strong>mysqldump</strong>进行数据库的逻辑备份。</p><h3 id="常见参数">常见参数</h3><table><colgroup><col style="width: 22%" /><col style="width: 4%" /><col style="width: 66%" /><col style="width: 6%" /></colgroup><thead><tr class="header"><th>参数名</th><th>缩写</th><th>含义</th><th>默认值</th></tr></thead><tbody><tr class="odd"><td>--user</td><td>-u</td><td>用户名</td><td></td></tr><tr class="even"><td>--password</td><td>-p</td><td>密码</td><td></td></tr><tr class="odd"><td>--host</td><td>-h</td><td>数据库地址</td><td></td></tr><tr class="even"><td>--port</td><td>-P</td><td>数据库端口号</td><td></td></tr><tr class="odd"><td>--databases</td><td>-B</td><td>指定要备份的数据库</td><td></td></tr><tr class="even"><td>--all-databases</td><td>-A</td><td>备份mysql服务器上所有的数据库</td><td></td></tr><tr class="odd"><td>--add-drop-database</td><td></td><td>每个数据库创建之前添加drop数据库语句</td><td>未开启</td></tr><tr class="even"><td>--add-drop-table</td><td></td><td>创建表之前添加drop语句</td><td>开启</td></tr><tr class="odd"><td>--event</td><td>-E</td><td>导出事件</td><td>未开启</td></tr><tr class="even"><td>--routines</td><td>-R</td><td>导出存储过程以及自定义函数</td><td>未开启</td></tr><tr class="odd"><td>--triggers</td><td></td><td>导出触发器</td><td>开启</td></tr><tr class="even"><td>--extended-insert</td><td>-e</td><td>使用具有多个VALUES列的INSERT语法</td><td>开启</td></tr><tr class="odd"><td>--ignore-table</td><td></td><td>指定不导出的表。需要忽略多个表时，需要重复多次</td><td></td></tr><tr class="even"><td>--no-data</td><td>-d</td><td>不导出任何数据，只导出数据库表</td><td></td></tr><tr class="odd"><td>--no-create-info</td><td>-t</td><td>只导出数据，不添加CREATE TABLE语句</td><td></td></tr><tr class="even"><td>--force</td><td>-f</td><td>导出过程中忽略SQL错误</td><td></td></tr><tr class="odd"><td>--tz-utc</td><td></td><td>导出顶部设置时区TIME_ZONE='+00:00'</td><td>开启</td></tr><tr class="even"><td>--where</td><td>-w</td><td>只转储指定WHERE条件选择的记录</td><td></td></tr><tr class="odd"><td>--set-gtid-purged</td><td></td><td>是否添加SET @<span class="citation"data-cites="GLOBAL.GTID_PURGED输出">@GLOBAL.GTID_PURGED输出</span></td><td></td></tr><tr class="even"><td>--single-transaction</td><td></td><td>通过在一个事务中导出所有表从而创建一个一致性的快照，适用于innodb引擎</td><td></td></tr><tr class="odd"><td>--master-data</td><td></td><td>该选项将当前服务器的binlog的位置和文件名追加到输出文件中。如果为1，将会输出CHANGEMASTER命令；如果为2，输出的CHANGE MASTER命令前添加注释信息</td><td></td></tr></tbody></table><h3 id="参考命令">参考命令</h3><p><strong>导出、导入所有的库</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -proot -hlocalhost -A &gt; all_mysql_data.sql</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -proot -hlocalhost &lt; all_muysql_data.sql</span><br></pre></td></tr></table></figure><p><strong>导出、导入指定库</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -proot -hlocalhost newcoder &gt; newcoder.sql</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -proot -hlocalhost &lt; newcoder.sql</span><br></pre></td></tr></table></figure><p><strong>导出、导入某几个库</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -proot -hlocalhost -B aaa bbb &gt; aaa_bbb.sql</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -proot -hlocalhost &lt; aaa_bbb.sql</span><br></pre></td></tr></table></figure><p><strong>导出、导入某个库的某些表数据</strong></p><p>比如操作aaa数据库的bbb表和ccc表</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以在导出时加--add-locks参数，表示导出时锁定数据库表</span></span><br><span class="line">mysqldump -uroot -proot -hlocalhost aaa bbb ccc &gt; bbb_ccc.sql</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 要确保aaa库存在</span></span><br><span class="line">mysql -uroot -proot -hlocalhost aaa  &lt; bbb_ccc.sql</span><br></pre></td></tr></table></figure><p><strong>只导出数据库结构，不导出数据</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -proot -hlocalhost aaa -d &gt; bbb_ccc.sql</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 要确保aaa库存在</span></span><br><span class="line">mysql -uroot -proot -hlocalhost aaa &lt; bbb_ccc.sql</span><br></pre></td></tr></table></figure><h2 id="物理备份">物理备份</h2><p>数据库文件级备份，备份内容是操作系统上数据库文件，常见工具为MySQLXtraBackup、Oracle RMAN等。</p><p>由存储数据库的内容和文件的副本组成，适用于大型数据库。</p><p>优点是备份速度快，恢复速度快，体积小。</p><p>如果数据库正在运行，需要先执行锁定数据库，防止在备份期间更改数据库的内容。</p><p>一般使用XtraBackup进行数据备份。</p><h3 id="xtrabackup优点">Xtrabackup优点</h3><ul><li><p>备份速度快，物理备份可靠</p></li><li><p>备份过程不会打断正在执行的事务（无需锁表）</p></li><li><p>能够基于压缩等功能节约磁盘空间和流量</p></li><li><p>自动备份校验</p></li><li><p>还原速度快</p></li><li><p>可以流传将备份传输到另外一台机器上</p></li><li><p>在不增加服务器负载的情况备份数据</p></li></ul><h3 id="xtrabackup常见参数">Xtrabackup常见参数</h3><table><colgroup><col style="width: 22%" /><col style="width: 72%" /><col style="width: 4%" /></colgroup><thead><tr class="header"><th>参数</th><th>含义</th><th>备注</th></tr></thead><tbody><tr class="odd"><td>--backup</td><td>备份到指定目录</td><td></td></tr><tr class="even"><td>--target-dir</td><td>指定目录</td><td></td></tr><tr class="odd"><td>--stream</td><td>流式传输指定备份，参数xbstream</td><td></td></tr><tr class="even"><td>--compress</td><td>是否启用压缩备份</td><td></td></tr><tr class="odd"><td>--compress-threads</td><td>指定压缩线程</td><td></td></tr><tr class="even"><td>--databases</td><td>指定要备份的数据库</td><td></td></tr><tr class="odd"><td>--databases-exclude</td><td>排除要备份的数据库</td><td></td></tr><tr class="even"><td>--user</td><td>用户名</td><td></td></tr><tr class="odd"><td>--password</td><td>密码</td><td></td></tr><tr class="even"><td>--host</td><td>数据库IP</td><td></td></tr><tr class="odd"><td>--rsync</td><td>使用rsync工具优化本地传输，当指定这个选项，innobackupex使用rsync拷贝非Innodb文件而替换cp，当有很多DB和表的时候会快很多，不能--stream一起使用。</td><td></td></tr></tbody></table><h3 id="参考命令-1">参考命令</h3><p><strong>流式备份并压缩、解压</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup --backup --user=root --password=root --host=192.168.31.75 --stream=xbstream | gzip  &gt; `<span class="built_in">date</span> +%Y%m%d`.gz</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gzip -f -d &lt; `<span class="built_in">date</span> +%Y%m%d`.gz  | xbstream -x -C mysql</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文主要介绍MySQL备份。&lt;/p&gt;
&lt;p&gt;关键词：&lt;strong&gt;MySQL&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="SRE" scheme="https://fly97.cn/tags/SRE/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes集群实践（十一）编写一个自定义资源CRD</title>
    <link href="https://fly97.cn/p/create-crd-in-kubernetes/"/>
    <id>https://fly97.cn/p/create-crd-in-kubernetes/</id>
    <published>2022-09-04T06:38:00.000Z</published>
    <updated>2022-09-04T06:38:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要介绍如何在Kubernetes编写自定义资源CRD。</p><p>关键词：<strong>k8s</strong></p><span id="more"></span><h2 id="前言">前言</h2><p>Kubernetes的最大亮点之一必定是它的声明式API设计，所谓的声明式就是告诉Kubernetes你要什么，而不是告诉它怎么做命令。我们日常使用Kubernetes做编排工作的时候，经常会接触Deployment、Service、Pod等资源对象，我们可以很灵活地创建其定义配置，然后执行kubectlapply命令，Kubernetes总能为我们创建相关资源对象并完成资源的注册，进而执行资源所负责的功能。</p><p>CRD，称之为自定义资源定义，本质上，它的表现形式是一段声明，用于定义用户定义的资源对象罢了。单单通过它还不能产生任何收益，因为开发者还要针对CRD定义提供关联的CRD对象CRD控制器（CRDController）。CRD控制器通常可以通过Golang进行开发，只需要遵循Kubernetes的控制器开发规范，并基于client-go进行调用，并实现Informer、ResourceEventHandler、Workqueue等组件逻辑即可。听起来感觉很复杂的样子，不过其实真正开发的时候，并不困难，因为大部分繁琐的代码逻辑都能通过Kubernetes的codegenerator代码生成出来。关于如何进行CRD控制器的开发，下面我们会通过一个例子慢慢地深入，希望通过实践来理解CRD的原理。</p><h2 id="声明式api">声明式API</h2><h3 id="命令式api">命令式API</h3><p>首先，声明式API是相对于命令式API而言的。</p><p>假设我们想创建一个deployment，可以创建一个下面的yaml文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>然后在master执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nginx.yaml</span><br></pre></td></tr></table></figure><p>然后这两个Pod就跑起来了。</p><p>如果想修改上的资源清单，需要先修改资源文件，然后再执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl replace -f nginx.yaml</span><br></pre></td></tr></table></figure><p>以上基于yaml文件操作的方式，被称作命令式API。同样属于命令式API的还有DockerSwarm的创建方式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service create --name nginx --replicas 2  nginx</span><br></pre></td></tr></table></figure><h3 id="声明式api-1">声明式API</h3><p><strong>kubectl apply</strong> 的操作属于声明式API。</p><p>kubectlreplace的操作，可以看作是使用新的YAML文件的API对象，<strong>替换原有的API对象</strong>；kubectlset image和 kubelctl edit也是对原有对象的修改，这些都属于命令式API。</p><p>kube-apiserver在响应命令式请求时，只能一次处理一个写请求，否则可能会出现冲突。</p><p>而对于apply的声明式请求，可以一次处理多个写操作，并且具备merge能力。</p><p>所谓声明式API，<strong>就是告诉kubernetes你要什么，而不是告诉他怎么做命令</strong>。在日常做容器编排时，经常会操作Deployment、Service、Pod等资源对象，我们可以很灵活的创建其自定义配置，然后执行kubectlapply命令，kubernetes可以创建相关资源对象并完成资源的注册，进而执行资源所负责的功能。</p><p>有了自定义API对象，开发者就不需要逐一进行Deployment、Service、ConfigMap等步骤，而是创建一些可以表述整个应用程序或者软件服务的对象。除此之外，我们还可以在创建高阶对象的基础上创建底层对象。例如：我们想要创建一个backup资源，在定义yaml的同时，可以希望通过spec的定义进行日常的备份操作声明，当提交给k8s集群时，相关的Deployment、Service资源会被自动创建，很大程度上让业务扩展性加大。</p><h3 id="crd">CRD</h3><p>CRD，称之为自定义资源定义，本质上，它的表现形式是一段声明，用于定义用户定义的资源对象罢了。单单通过它还不能产生任何收益，因为开发者还要针对CRD定义提供关联的CRD对象CRD控制器（CRDController）。CRD控制器通常可以通过Golang进行开发，只需要遵循Kubernetes的控制器开发规范，并基于client-go进行调用，并实现Informer、ResourceEventHandler、Workqueue等组件逻辑即可。听起来感觉很复杂的样子，不过其实真正开发的时候，并不困难，因为大部分繁琐的代码逻辑都能通过Kubernetes的codegenerator代码生成出来。关于如何进行CRD控制器的开发，下面我们会通过一个例子慢慢地深入，希望通过实践来理解CRD的原理。</p><h2 id="api">API</h2><p>整个kubernetes里所有API对象都可以用下面的树形结构表示出来：</p><p><img data-src="编写一个自定义资源对象CRD/NeatReader-1663224393771.png" /></p><p>可以看出，API对象的组织方式，是层层递进的。</p><p>如果现在想要创建一个CronJob对象，那么YAML文件的开始部分需要这样写：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiversion:</span> <span class="string">batch/v2alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br></pre></td></tr></table></figure><p>对于上文，Crontab是这个API对象的资源类型，batch是他的组，v2alpha1是版本；</p><p>当提交了这个yaml文件一行，kubernetes就会把这个YAML文件描述内容，转换成一个CronJob对象</p><p>apiserver会遵循以下的流程：</p><ol type="1"><li><p>匹配API对象的组。</p><p>通常核心对象如Pod、Node不需要group，直接在/api这个层级下进行匹配；</p><p>而对于CronJob等非核心API对象来说，Kubernetes必须在/apis这个层级下找到对应的Group，根据batch，找到/apis/batch。</p><p>API是根据对象功能为依据的。如Job和CronJob就属于batch这个Group。</p></li><li><p>匹配API对象的版本号</p><p>对于CronJob这个API对象来说，Kubernetes在batch这个Group下，匹配的版本号就是v2alpha1</p><p>K8s中同一种API对象可以由多个版本，这正是K8s进行API版本化管理的手段</p></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文主要介绍如何在Kubernetes编写自定义资源CRD。&lt;/p&gt;
&lt;p&gt;关键词：&lt;strong&gt;k8s&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="k8s" scheme="https://fly97.cn/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes集群实践（十）在Kubernetes部署MinIO对象存储服务器</title>
    <link href="https://fly97.cn/p/Install-MinIO-on-k8s/"/>
    <id>https://fly97.cn/p/Install-MinIO-on-k8s/</id>
    <published>2022-08-04T05:25:00.000Z</published>
    <updated>2022-08-04T05:25:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要介绍如何安装和使用云原生对象存储服务器MinIO。</p><p>关键词：<strong>k8s</strong></p><span id="more"></span><h2 id="前言">前言</h2><p>MinIO 是在 GNU Affero 通用公共许可证 v3.0下发布的高性能对象存储。它与 Amazon S3 云存储服务 API 兼容。使用 MinIO为机器学习、分析和应用程序数据工作负载构建高性能基础架构。</p><p>本文主要介绍如何使用<ahref="https://github.com/minio/operator/blob/master/README.md">MinIOKubernetes Operator</a>部署和安装MinIO。</p><h2 id="准备工作">准备工作</h2><p>正常运行的K8s集群，这里使用三个master节点，两个worker节点进行演示；</p><p><img data-src="2022-08-12-14-15-48-image.png" /></p><p>在K8s上部署MinIO一般有两种方式，一种是通过Helm进行自动安装，还有一种是通过<strong>MinIOKubernetesOperator</strong>部署安装。处于学习的角度考虑，这里采用Operator进行手动安装</p><h2 id="部署minio-operator">部署MinIO Operator</h2><h3 id="安装kubectl-minio插件">安装kubectl-minio插件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/minio/operator/releases/latest/download/kubectl-minio_linux_amd64.zip</span><br><span class="line">sudo unzip kubectl-minio_linux_amd64.zip -d /usr/local/bin/</span><br></pre></td></tr></table></figure><p>检查是否正常安装</p><p>如果显示版本号则说明插件安装成功</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wf09@amd-server ➜  ~ kubectl minio version</span><br><span class="line">v4.4.28</span><br></pre></td></tr></table></figure><h3 id="初始化minio-operator">初始化MinIO Operator</h3><h4 id="部署">部署</h4><p><code>--image</code>、<code>--console-image</code>分别指定私有仓库的镜像，这样可以节约部署的时间</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl minio init \</span><br><span class="line">--image=hub.deepsoft-tech.com/minio/operator \</span><br><span class="line">--console-image=hub.deepsoft-tech.com/minio/console</span><br></pre></td></tr></table></figure><p>稍候片刻，可以看到下面的回显，说明部署完毕</p><p><img data-src="2022-08-12-15-04-50-image.png" /></p><h4 id="查看部署的资源">查看部署的资源</h4><p>可以查看minio-operator命名空间下的资源</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all -n minio-operator</span><br></pre></td></tr></table></figure><p><img data-src="2022-08-12-15-06-13-image.png" /></p><p>当所有Pod都为Running时，表示服务已经Ready了</p><h4 id="登录operator控制台">登录operator控制台</h4><p>可以通过kube-proxy访问控制台</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl minio proxy </span><br></pre></td></tr></table></figure><p><img data-src="2022-08-12-15-41-52-image.png" /></p><p>记录JWT，并输入打开的浏览器页面</p><p><img data-src="2022-08-12-15-43-33-image.png" /></p><p>输入JWT，跳转到下一步</p><p><img data-src="2022-08-12-15-46-50-image.png" /></p><h2 id="部署多租户minio-tenant集群">部署多租户MinIO tenant集群</h2><h3 id="创建storangeclass">创建StorangeClass</h3><p>可以通过外部StorangeClass+PVC可以实现自动生成PV。</p><h4 id="k3s-local-path-provisioner-storangeclass">K3slocal-path-provisioner StorangeClass</h4><p>K3s Local PV 可以在本机通过PV控制器与Scheduler的结合，会对localPV做针对性的逻辑处理，从而，让Pod在多次调度时，能够调度到同一个Node上。</p><p>安装方式也很简单，默认在K3s集群中就自动安装完毕了。</p><p>若之前禁用了此安装，只需删除<code>--disable=local-storage</code>即可。</p><h4 id="minio-directpv-storangeclass">MinIO directpv StorangeClass</h4><p>DirectPV是用于直连存储的CSI驱动程序。从更简单的意义上讲，它是一个分布式持久卷管理器，而不是像SAN或NAS这样的存储系统。跨服务器发现、格式化、装载、调度和监视驱动器非常有用。由于<strong>KuberneteshostPath和LocalPV</strong>是静态配置的，并且功能有限，因此创建DirectPV就是为了解决这一限制。</p><p>以下是安装步骤</p><ol type="1"><li><p>安装kubectl directpv插件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/minio/directpv/releases/latest/download/kubectl-directpv_linux_amd64.zip</span><br><span class="line">sudo unzip kubectl-directpv_linux_amd64.zip -d /usr/local/bin/</span><br></pre></td></tr></table></figure></li><li><p>检查是否安装成功</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl directpv --version</span><br></pre></td></tr></table></figure></li></ol><p>    如显示版本号说明安装成功了</p><ol start="3" type="1"><li><p>初始化 directpv</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl directpv init </span><br></pre></td></tr></table></figure></li><li><p>检查是否初始化成功</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all -n direct-csi-min-io</span><br></pre></td></tr></table></figure><p>查看上述命令的回显，如果PodStatus全部显示Running说明初始化成功</p></li><li><p>格式化磁盘</p><p>以下命令可以格式化所有磁盘，当所有磁盘格式化完毕以后，就可以分配PV了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl directpv drives format -a</span><br></pre></td></tr></table></figure><p>如果想释放某个节点，即不让该节点的设备分配PV，可以执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl directpv drives release --nodes amd-server</span><br></pre></td></tr></table></figure></li><li><p>查看节点磁盘状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl directpv drives <span class="built_in">ls</span></span><br></pre></td></tr></table></figure></li></ol><p>    显示为Ready的节点，可以分配PV</p><p>    <img title="" data-src="2022-08-12-18-24-17-image.png" alt="" data-align="inline" width="611"></p><h3 id="创建-minio-tenant集群">创建 MinIO tenant集群</h3><h4 id="创建命名空间">创建命名空间</h4><p>需要将minio租户放在一个特定的命名空间中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns minio</span><br></pre></td></tr></table></figure><h4 id="创建-minio-tenant集群-1">创建 MinIO tenant集群</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl minio tenant create minio  \</span><br><span class="line">  --servers 4 \</span><br><span class="line">  --volumes 8 \</span><br><span class="line">  --capacity 200Gi \</span><br><span class="line">  --storage-class direct-csi-min-io \</span><br><span class="line">  --namespace minio \</span><br><span class="line">  --disable-tls</span><br></pre></td></tr></table></figure><table><colgroup><col style="width: 46%" /><col style="width: 53%" /></colgroup><thead><tr class="header"><th>参数</th><th>说明</th></tr></thead><tbody><tr class="odd"><td><ahref="https://docs.min.io/minio/k8s/reference/minio-kubectl-plugin.html#kubectl-minio-tenant-create-servers"><code>--servers</code></a></td><td><code>minio</code>要跨 Kubernetes 集群部署的服务器数量。</td></tr><tr class="even"><td><ahref="https://docs.min.io/minio/k8s/reference/minio-kubectl-plugin.html#kubectl-minio-tenant-create-volumes"><code>--volumes</code></a></td><td>集群中的卷数。通过将确定每个服务器的卷数通过。<ahref="https://docs.min.io/minio/k8s/reference/minio-kubectl-plugin.html#command-kubectl-minio"><code>kubectl minio</code></a><code>volumes``servers</code></td></tr><tr class="odd"><td><ahref="https://docs.min.io/minio/k8s/reference/minio-kubectl-plugin.html#kubectl-minio-tenant-create-capacity"><code>--capacity</code></a></td><td>集群的总容量。确定每个体积的通过划分容量通过。<ahref="https://docs.min.io/minio/k8s/reference/minio-kubectl-plugin.html#command-kubectl-minio"><code>kubectl minio</code></a><code>capacity``volumes</code></td></tr><tr class="even"><td><ahref="https://docs.min.io/minio/k8s/reference/minio-kubectl-plugin.html#kubectl-minio-tenant-create-storage-class"><code>--storage-class</code></a></td><td><code>StorageClass</code>创建每个 PVC 时要使用的 Kubernetes。此示例使用 MinIO <ahref="https://github.com/minio/direct-csi">DirectCSI</a> 存储类。</td></tr><tr class="odd"><td><ahref="https://docs.min.io/minio/k8s/reference/minio-kubectl-plugin.html#kubectl-minio-tenant-create-namespace"><code>--namespace</code></a></td><td>用于部署 MinIO 租户的 Kubernetes 命名空间。</td></tr></tbody></table><p>注释：我们的集群有4个节点，<code>--servers=4</code>；总共4个卷，即每个节点上各有一个卷<code>--volumes 4</code>；总共容量是100G（由于奇偶校验等原因，最大可以存50G的数据）<code>-capacity 100Gi</code>；</p><p><img data-src="2022-08-15-14-00-42-image.png" /></p><h3 id="将集群暴露至外部">将集群暴露至外部</h3><p>将对应的service连接至ingress即可。</p><h4 id="s3-api">s3 API</h4><p>s3 API对应的是 minio Service</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">minio</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">minio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">s3.deepsoft-tech.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">minio</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><h4 id="minio-控制台">MinIO 控制台</h4><p>控制台对应的是 minio-console Service</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">minio-console</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">minio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">minio-console.deepsoft-tech.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">minio-console</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">9090</span></span><br></pre></td></tr></table></figure><h4 id="检查">检查</h4><p>登录控制台，查看s3存储桶信息</p><p><img data-src="2022-08-15-14-07-09-image.png" /></p><h2 id="使用-minio-client-连接-minio-集群">使用 MinIO Client 连接 minio集群</h2><h3 id="binary-download-gnulinux">Binary Download (GNU/Linux)</h3><table><colgroup><col style="width: 12%" /><col style="width: 16%" /><col style="width: 71%" /></colgroup><thead><tr class="header"><th>Platform</th><th>Architecture</th><th>URL</th></tr></thead><tbody><tr class="odd"><td>GNU/Linux</td><td>64-bit Intel</td><td>https://dl.min.io/client/mc/release/linux-amd64/mc</td></tr><tr class="even"><td></td><td>64-bit PPC</td><td>https://dl.min.io/client/mc/release/linux-ppc64le/mc</td></tr></tbody></table><h3 id="docker">Docker</h3><h4 id="docker-stable">Docker Stable</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull minio/mc </span><br><span class="line">docker run minio/mc <span class="built_in">ls</span> play</span><br></pre></td></tr></table></figure><h4 id="docker-edge">Docker Edge</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull minio/mc:edge</span><br><span class="line">docker run minio/mc:edge <span class="built_in">ls</span> play</span><br></pre></td></tr></table></figure><p><strong>Note:</strong> Above examples run <code>mc</code> againstMinIO <ahref="https://docs.min.io/docs/minio-client-complete-guide.html#test-your-setup"><em>play</em> environment</a> bydefault. To run <code>mc</code> against other S3 compatible servers,start the container this way:</p><p>Copy<code>docker run -it --entrypoint=/bin/sh minio/mc</code></p><p>then use the <ahref="https://docs.min.io/docs/minio-client-complete-guide.html#3-add-a-cloud-storage-service"><code>mc alias</code> command</a>.</p><h3 id="添加集群">添加集群</h3><p>账户名：root，密码：rootroot</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mc config host add k8s http://s3.deepsoft-tech.com root rootroot --api s3v4</span><br></pre></td></tr></table></figure><h4 id="查看集群的桶">查看集群的桶</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mc <span class="built_in">ls</span> k8s</span><br></pre></td></tr></table></figure><p><img data-src="2022-08-15-14-46-20-image.png" /></p><h4 id="备份文件到指定集群">备份文件到指定集群</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mc mirror -a textbook/ k8s/textbook</span><br></pre></td></tr></table></figure><ul><li><p><code>-a</code> ：属性同步备份</p></li><li><p><code>-w</code>：阻塞备份，<code>--watch</code></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文主要介绍如何安装和使用云原生对象存储服务器MinIO。&lt;/p&gt;
&lt;p&gt;关键词：&lt;strong&gt;k8s&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="k8s" scheme="https://fly97.cn/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes集群实践（九）使用StatefulSet 搭建高可用的MySQL集群</title>
    <link href="https://fly97.cn/p/install-mysql-ha-on-k8s/"/>
    <id>https://fly97.cn/p/install-mysql-ha-on-k8s/</id>
    <published>2022-07-27T15:28:00.000Z</published>
    <updated>2022-07-27T15:28:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要介绍如何使用StatefulSet搭建高可用的MySQL集群。</p><p>关键词：<strong>k8s</strong></p><span id="more"></span><h2 id="前言">前言</h2><p>为什么要用K8s搭建MySQL集群？</p><ul><li>在业务全面上云的背景下，为了要使用现有的设备快速搭建高可用的MySQL集群，K8s无非是一种比较方便的方案。</li></ul><h2 id="statefulset">StatefulSet</h2><p>StatefulSet被用来管理<strong>有状态应用</strong>的工作负载API对象。MySQL服务就是一个典型的有状态应用。</p><p>和Deployment类似，StatefulSet也是用来管理基于相同容器Spec的一组Pod。但和Deployment不同的是，StatefulSet为他们的Pod维护了一个<strong>有粘性的ID</strong>。这些Pod是基于相同的Spec来创建的，但是不能替换：无论怎么调度，他们Pod都有一个永久不变的ID。</p><p>如果使用PV卷为Pod提供持久存储，可以使用StatefulSet作为解决方案的一部分，尽管StatefulSet中的单个Pod仍可能出现故障，但持久的Pod 标识符使得将现有卷与替换已失败 Pod 的新 Pod 相匹配变得更加容易。</p><p>StatefulSet主要用于以下状态的应用更新：</p><ul><li>需要稳定的、唯一的网络标识符；</li><li>需要稳定的、持久的存储；</li><li>需要有序的、优雅的部署和扩缩；</li><li>需要有序的、自动的滚动更新。</li></ul><p>稳定意味着Pod的调度或者重新调度的整个过程是持久性的；</p><p>如果应用程序不需要任何稳定的标识符或者有序的部署、删除或扩缩，则应该使用无状态的副本控制提供的工作负载来部署应用程序，如Deployment或者ReplicaSet；</p><ul><li>StatefulSet的应用都是一个一个<strong>依次创建</strong>的；</li></ul><h3 id="限制">限制</h3><ul><li><p>Pod存储必须要由PV驱动基于StrongeClass来提供，或者由管理员预先提供；</p></li><li><p>删除或者扩缩StatefulSet<strong>不会删除它关联的PVC</strong>；</p></li><li><p>StatefulSet需要<strong>无头服务（headlessservice）</strong>来负责创建Pod的网络标识，管理员需要创建此服务；</p></li><li><p>当删除一个StatefulSet时，StatefulSet不提供任何终止Pod的保证。为了实现StatefulSet有序终止，可以在删除之前将StatefulSet缩容至0；</p></li><li><p>默认Pod管理策略是滚动更新，出现异常时可能<strong>需要人工干预</strong>才能恢复</p></li></ul><h3 id="组件">组件</h3><p>下面的示例演示了StatefulSet的组件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># 必须匹配 .spec.template.metadata.labels</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span> <span class="comment"># 默认值是 1</span></span><br><span class="line">  <span class="attr">minReadySeconds:</span> <span class="number">10</span> <span class="comment"># 默认值是 0</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># 必须匹配 .spec.selector.matchLabels</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">k8s.gcr.io/nginx-slim:0.8</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&quot;my-storage-class&quot;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure><h2 id="mysql-ha搭建">MySQL HA搭建</h2><p>普通MySQL集群的搭建可以参考：https://www.modb.pro/db/29214</p><p>主要就是以下几个步骤：</p><ol type="1"><li>安装数据库</li><li>主库开启binlog</li><li>授权</li><li>登陆主库查看此时日子状态</li><li>导出主库当前数据</li><li>从库和指定serverid</li><li>从库写入主库数据</li><li>指定开始同步位置</li></ol><p>K8s集群上的MySQL集群搭建略有不同，主要通过StatefulSet+ConfigMap+initContainer的模式和xtrabackup+ncat软件来实现主从复制；</p><ol type="1"><li>首先创建主库和从库的my.cnf文件，存入ConfigMap。这样可以持久化配置文件；</li><li>然后创建InitContainer。InitContainer容器是首先创建的容器，且该容器成功推出是PodReady的比较条件；<ul><li>InitContainer：init-mysql主要任务是根据hostname，选择拷贝主库的配置文件还是从库的文件到Volume中，这样就区分了Master和Slave；</li><li>InitContainer：clone-mysql任务是为<strong>级联复制</strong>做准备。如果存在数据，跳过克隆；跳过主库的克隆；从上一个Ready的Pod克隆数据来；准备备份为后面的节点服务；</li></ul></li><li>创建Container。这里的Container就是正常业务的MySQL容器了；</li><li>创建<strong>Sicar</strong>Container：backup-sql，主要任务是：调整当前节点的主从设置；准备为下一个节点提供复制的文件</li></ol><h3 id="资源清单文件">资源清单文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-ha</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">init.sql:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    use mysql;</span></span><br><span class="line"><span class="string">    /* update user set host = &#x27;%&#x27; where user =&#x27;root&#x27;;</span></span><br><span class="line"><span class="string">    flush privileges; */</span></span><br><span class="line"><span class="string">    grant all privileges on *.* to &#x27;root&#x27;@&#x27;%&#x27;;</span></span><br><span class="line"><span class="string">    flush privileges;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">primary.cnf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    # 仅在主服务器上应用此配置</span></span><br><span class="line"><span class="string">    [mysqld]</span></span><br><span class="line"><span class="string">    lower_case_table_names=1</span></span><br><span class="line"><span class="string">    relay-log=mysql-relay</span></span><br><span class="line"><span class="string">    log-bin=mysql-bin</span></span><br><span class="line"><span class="string">    gtid_mode=on</span></span><br><span class="line"><span class="string">    enforce_gtid_consistency</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    <span class="string">max_connections=1000</span></span><br><span class="line">    <span class="string">character_set_server=utf8mb4</span></span><br><span class="line">    <span class="string">collation_server=utf8mb4_general_ci</span></span><br><span class="line">    <span class="string">default_authentication_plugin=mysql_native_password</span></span><br><span class="line">  <span class="attr">replica.cnf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    # 仅在副本服务器上应用此配置</span></span><br><span class="line"><span class="string">    [mysqld]</span></span><br><span class="line"><span class="string">    lower_case_table_names=1</span></span><br><span class="line"><span class="string">    log_replica_updates=1</span></span><br><span class="line"><span class="string">    relay-log=mysql-relay</span></span><br><span class="line"><span class="string">    log-bin=mysql-bin</span></span><br><span class="line"><span class="string">    gtid_mode=on</span></span><br><span class="line"><span class="string">    enforce_gtid_consistency</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    <span class="string">max_connections=1000</span></span><br><span class="line">    <span class="string">character_set_server=utf8mb4</span></span><br><span class="line">    <span class="string">collation_server=utf8mb4_general_ci</span></span><br><span class="line">    <span class="string">default_authentication_plugin=mysql_native_password</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 为 StatefulSet 成员提供稳定的 DNS 表项的无头服务（Headless Service）</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 用于连接到任一 MySQL 实例执行读操作的客户端服务</span></span><br><span class="line"><span class="comment"># 对于写操作，你必须连接到主服务器：mysql-0.mysql</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-read</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">readonly:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">999</span></span><br><span class="line">        <span class="attr">runAsGroup:</span> <span class="number">999</span></span><br><span class="line">        <span class="attr">fsGroup:</span> <span class="number">999</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">label-pod</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">hub.deepsoft-tech.com/wf09/curl</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PODNAME</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">bash</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          set -ex</span></span><br><span class="line"><span class="string">          APISERVER=https://kubernetes.default.svc</span></span><br><span class="line"><span class="string">          # 服务账号令牌的路径</span></span><br><span class="line"><span class="string">          SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line"><span class="string">          # 读取 Pod 的名字空间</span></span><br><span class="line"><span class="string">          NAMESPACE=$(cat $&#123;SERVICEACCOUNT&#125;/namespace)</span></span><br><span class="line"><span class="string">          # 读取服务账号的持有者令牌</span></span><br><span class="line"><span class="string">          TOKEN=$(cat $&#123;SERVICEACCOUNT&#125;/token)</span></span><br><span class="line"><span class="string">          # 引用内部证书机构（CA）</span></span><br><span class="line"><span class="string">          CACERT=$&#123;SERVICEACCOUNT&#125;/ca.crt</span></span><br><span class="line"><span class="string">          # 使用令牌访问 API</span></span><br><span class="line"><span class="string">          # 基于 Pod 序号生成 MySQL 服务器的 ID。</span></span><br><span class="line"><span class="string">          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1</span></span><br><span class="line"><span class="string">          ordinal=$&#123;BASH_REMATCH[1]&#125;</span></span><br><span class="line"><span class="string">          if [[ $ordinal -eq 0 ]]; then</span></span><br><span class="line"><span class="string">            FLAG=false</span></span><br><span class="line"><span class="string">          else</span></span><br><span class="line"><span class="string">            FLAG=true</span></span><br><span class="line"><span class="string">          fi</span></span><br><span class="line"><span class="string">          curl -X PATCH  \</span></span><br><span class="line"><span class="string">            --cacert $&#123;CACERT&#125; \</span></span><br><span class="line"><span class="string">            -H &quot;Content-Type:application/json-patch+json&quot; \</span></span><br><span class="line"><span class="string">            -H &quot;Authorization: Bearer $&#123;TOKEN&#125;&quot; $&#123;APISERVER&#125;/api \</span></span><br><span class="line"><span class="string">            -d \</span></span><br><span class="line"><span class="string">            &#x27;[</span></span><br><span class="line"><span class="string">                &#123; </span></span><br><span class="line"><span class="string">                  &quot;op&quot;: &quot;add&quot;,</span></span><br><span class="line"><span class="string">                  &quot;path&quot;: &quot;/metadata/labels/readonly&quot;,</span></span><br><span class="line"><span class="string">                  &quot;value&quot;: &quot;&#x27;&quot;$FLAG&quot;&#x27;&quot; </span></span><br><span class="line"><span class="string">                &#125; </span></span><br><span class="line"><span class="string">            ]&#x27; \</span></span><br><span class="line"><span class="string">            $&#123;APISERVER&#125;/api/v1/namespaces/$&#123;NAMESPACE&#125;/pods/$&#123;PODNAME&#125;</span></span><br><span class="line"><span class="string"></span>      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-mysql</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ubuntu</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">bash</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          set -ex</span></span><br><span class="line"><span class="string">          # 基于 Pod 序号生成 MySQL 服务器的 ID。</span></span><br><span class="line"><span class="string">          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1</span></span><br><span class="line"><span class="string">          ordinal=$&#123;BASH_REMATCH[1]&#125;</span></span><br><span class="line"><span class="string">          echo [mysqld] &gt; /mnt/conf.d/server-id.cnf</span></span><br><span class="line"><span class="string">          # 添加偏移量以避免使用 server-id=0 这一保留值。</span></span><br><span class="line"><span class="string">          echo server-id=$((100 + $ordinal)) &gt;&gt; /mnt/conf.d/server-id.cnf</span></span><br><span class="line"><span class="string">          # 将合适的 conf.d 文件从 config-map 复制到 emptyDir。</span></span><br><span class="line"><span class="string">          if [[ $ordinal -eq 0 ]]; then</span></span><br><span class="line"><span class="string">            cp /mnt/config-map/primary.cnf /mnt/conf.d/</span></span><br><span class="line"><span class="string">          else</span></span><br><span class="line"><span class="string">            cp /mnt/config-map/replica.cnf /mnt/conf.d/</span></span><br><span class="line"><span class="string">          fi</span></span><br><span class="line"><span class="string">          echo &quot;Find init.sql...&quot;</span></span><br><span class="line"><span class="string">          cp /mnt/config-map/init.sql /docker-entrypoint-initdb.d/init.sql</span></span><br><span class="line"><span class="string">          [[ $? -eq 0 ]] || exit 1</span></span><br><span class="line"><span class="string">          cat /docker-entrypoint-initdb.d/init.sql</span></span><br><span class="line"><span class="string">          ls -l /var/lib/mysql</span></span><br><span class="line"><span class="string">          [[ $? -eq 0 ]] || exit 1</span></span><br><span class="line"><span class="string"></span>        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-sql</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/docker-entrypoint-initdb.d/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">conf</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/mnt/conf.d</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-map</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/mnt/config-map</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">clone-mysql</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">hub.deepsoft-tech.com/wf09/backupsql</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">bash</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          set -ex</span></span><br><span class="line"><span class="string">          # 如果已有数据，则跳过克隆。</span></span><br><span class="line"><span class="string">          [[ -d /var/lib/mysql/mysql ]] &amp;&amp; exit 0</span></span><br><span class="line"><span class="string">          # 跳过主实例（序号索引 0）的克隆。</span></span><br><span class="line"><span class="string">          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1</span></span><br><span class="line"><span class="string">          ordinal=$&#123;BASH_REMATCH[1]&#125;</span></span><br><span class="line"><span class="string">          [[ $ordinal -eq 0 ]] &amp;&amp; exit 0</span></span><br><span class="line"><span class="string">          # 从原来的对等节点克隆数据。</span></span><br><span class="line"><span class="string">          ncat --recv-only mysql-$(($ordinal-1)).mysql 3307 | xbstream -x -C /var/lib/mysql</span></span><br><span class="line"><span class="string">          # 准备备份。</span></span><br><span class="line"><span class="string">          xtrabackup --prepare --target-dir=/var/lib/mysql          </span></span><br><span class="line"><span class="string"></span>        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">conf</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/mysql/conf.d</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">mysql:8.0.29-debian</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;root&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">socket</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/run/mysqld</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-sql</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/docker-entrypoint-initdb.d/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">conf</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/mysql/conf.d</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span> [<span class="string">&quot;mysqladmin&quot;</span>, <span class="string">&quot;ping&quot;</span>, <span class="string">&quot;-uroot&quot;</span>, <span class="string">&quot;-proot&quot;</span>]</span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">150</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="comment"># 检查我们是否可以通过 TCP 执行查询（skip-networking 是关闭的）。</span></span><br><span class="line">            <span class="attr">command:</span> [<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;-uroot&quot;</span>, <span class="string">&quot;-proot&quot;</span>, <span class="string">&quot;-e&quot;</span>, <span class="string">&quot;SELECT 1&quot;</span>]</span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">5</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">backup-sql</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">hub.deepsoft-tech.com/wf09/backupsql</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">xtrabackup</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">3307</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">bash</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          set -ex</span></span><br><span class="line"><span class="string">          cd /var/lib/mysql</span></span><br><span class="line"><span class="string">          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1</span></span><br><span class="line"><span class="string">          ordinal=$&#123;BASH_REMATCH[1]&#125;</span></span><br><span class="line"><span class="string">          # 如果是第0个说明是Master，跳过设置主从的部分</span></span><br><span class="line"><span class="string">          [[ $ordinal -eq 0 ]] &amp;&amp; exec ncat --listen --keep-open --send-only --max-conns=1 3307 -c \</span></span><br><span class="line"><span class="string">            &quot;xtrabackup --backup --slave-info --stream=xbstream --user=root --password=root&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;Waiting for mysqld to be ready (accepting connections)&quot;</span></span><br><span class="line">          <span class="string">until</span> <span class="string">mysql</span> <span class="string">-uroot</span> <span class="string">-proot</span> <span class="string">-e</span> <span class="string">&quot;SELECT 1&quot;</span> <span class="string">;</span> <span class="string">do</span> <span class="string">sleep</span> <span class="number">1</span><span class="string">;</span> <span class="string">done</span></span><br><span class="line"></span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;Initializing replication from clone position&quot;</span></span><br><span class="line">          <span class="string">mysql</span> <span class="string">-uroot</span> <span class="string">-proot</span> <span class="string">\</span></span><br><span class="line">                  <span class="string">-e</span> <span class="string">&quot;STOP SLAVE;&quot;</span>  <span class="string">\</span></span><br><span class="line">                  <span class="string">-e</span> <span class="string">&quot;RESET SLAVE;&quot;</span> <span class="string">\</span></span><br><span class="line">                  <span class="string">-e</span> <span class="string">&quot;CHANGE MASTER TO \</span></span><br><span class="line"><span class="string">                          MASTER_HOST=&#x27;mysql-0.mysql&#x27;, \</span></span><br><span class="line"><span class="string">                          MASTER_USER=&#x27;root&#x27;, \</span></span><br><span class="line"><span class="string">                          MASTER_PASSWORD=&#x27;root&#x27;, \</span></span><br><span class="line"><span class="string">                          MASTER_AUTO_POSITION = 1;&quot;</span> <span class="string">\</span></span><br><span class="line">                  <span class="string">-e</span> <span class="string">&quot;START SLAVE;&quot;</span> <span class="string">||</span> <span class="string">exit</span> <span class="number">1</span></span><br><span class="line">          <span class="string">exec</span> <span class="string">ncat</span> <span class="string">--listen</span> <span class="string">--keep-open</span> <span class="string">--send-only</span> <span class="string">--max-conns=1</span> <span class="number">3307</span> <span class="string">-c</span> <span class="string">\</span></span><br><span class="line">            <span class="string">&quot;xtrabackup --backup --slave-info --stream=xbstream --user=root --password=root&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">socket</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/run/mysqld</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">conf</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/mysql/conf.d</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">socket</span></span><br><span class="line">        <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">conf</span></span><br><span class="line">        <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-sql</span></span><br><span class="line">        <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-map</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mysql-ha</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">data</span>          </span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">rook-ceph-block</span></span><br><span class="line">      <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure><h2 id="如何给pod动态的增加label">如何给Pod动态的增加Label</h2><p>现在要求ServiceA可以直接连接主库，即可以直接连接到StatefulSet创建的第一个Pod；ServiceB可以直接连接所有的从库，即除去第一个Pod都可以通过Service负载均衡到后端Pod。</p><p>现在思路是通过 initContainerd 容器，在workPod起来之前中执行以下逻辑：</p><ul><li>判断hostname，如果带0，说明是第一个主库，通过REST API请求K8s APIServer，根据每一个Pod都会<strong>自动挂载默认ServiceAccount（投射卷）</strong>的机制，可以获取到请求K8s APIServer的密钥。</li></ul><p>部分资源清单：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">initContainers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">label-pod</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">hub.deepsoft-tech.com/wf09/curl</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PODNAME</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">bash</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">    set -ex</span></span><br><span class="line"><span class="string">    APISERVER=https://kubernetes.default.svc</span></span><br><span class="line"><span class="string">    # 服务账号令牌的路径</span></span><br><span class="line"><span class="string">    SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line"><span class="string">    # 读取 Pod 的名字空间</span></span><br><span class="line"><span class="string">    NAMESPACE=$(cat $&#123;SERVICEACCOUNT&#125;/namespace)</span></span><br><span class="line"><span class="string">    # 读取服务账号的持有者令牌</span></span><br><span class="line"><span class="string">    TOKEN=$(cat $&#123;SERVICEACCOUNT&#125;/token)</span></span><br><span class="line"><span class="string">    # 引用内部证书机构（CA）</span></span><br><span class="line"><span class="string">    CACERT=$&#123;SERVICEACCOUNT&#125;/ca.crt</span></span><br><span class="line"><span class="string">    # 使用令牌访问 API</span></span><br><span class="line"><span class="string">    # 基于 Pod 序号生成 MySQL 服务器的 ID。</span></span><br><span class="line"><span class="string">    [[ `hostname` =~ -([0-9]+)$ ]] || exit 1</span></span><br><span class="line"><span class="string">    ordinal=$&#123;BASH_REMATCH[1]&#125;</span></span><br><span class="line"><span class="string">    if [[ $ordinal -eq 0 ]]; then</span></span><br><span class="line"><span class="string">      FLAG=false</span></span><br><span class="line"><span class="string">    else</span></span><br><span class="line"><span class="string">      FLAG=true</span></span><br><span class="line"><span class="string">    fi</span></span><br><span class="line"><span class="string">    curl -X PATCH  \</span></span><br><span class="line"><span class="string">      --cacert $&#123;CACERT&#125; \</span></span><br><span class="line"><span class="string">      -H &quot;Content-Type:application/json-patch+json&quot; \</span></span><br><span class="line"><span class="string">      -H &quot;Authorization: Bearer $&#123;TOKEN&#125;&quot; $&#123;APISERVER&#125;/api \</span></span><br><span class="line"><span class="string">      -d \</span></span><br><span class="line"><span class="string">      &#x27;[</span></span><br><span class="line"><span class="string">          &#123; </span></span><br><span class="line"><span class="string">            &quot;op&quot;: &quot;add&quot;,</span></span><br><span class="line"><span class="string">            &quot;path&quot;: &quot;/metadata/labels/readonly&quot;,</span></span><br><span class="line"><span class="string">            &quot;value&quot;: &quot;&#x27;&quot;$FLAG&quot;&#x27;&quot; </span></span><br><span class="line"><span class="string">          &#125; </span></span><br><span class="line"><span class="string">      ]&#x27; \</span></span><br><span class="line"><span class="string">      $&#123;APISERVER&#125;/api/v1/namespaces/$&#123;NAMESPACE&#125;/pods/$&#123;PODNAME&#125;</span></span><br></pre></td></tr></table></figure><p>上面</p><p>⚠️默认情况下默认服务账号是不能更改PodLabel的，需要执行一下资源清单开放权限</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">patch-my-pods</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">patch-my-pods</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>] <span class="comment"># &quot;&quot; indicates the core API group</span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">patch-my-pods</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">patch-my-pods</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure><p>apply以后可以检查一下自己是否有权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl auth can-i patch pods --as=system:serviceaccount:default:default -n default</span><br></pre></td></tr></table></figure><p>执行完以上操作就可以动态的Pod添加标签啦～</p><h2 id="问题">问题</h2><h3 id="error-my-010544-repl-failed-to-open-the-relay-log">[ERROR][MY-010544] [Repl] Failed to open the relay log</h3><p>当使用xtrabackup对<strong>从库</strong>进行冷备份时，并使用这个从库的备份创建一个新的从库实例时，会出现此问题。</p><p>通过relaylog介绍，很容易知道由于mysql.slave_relay_log_info表中保留了以前的复制信息，导致新从库启动时无法找到对应文件。</p><p>此时需要登陆到从库的MySQL实例，重置一下slave即可</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> stop slave;</span><br><span class="line">mysql<span class="operator">&gt;</span> reset slave;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave;</span><br></pre></td></tr></table></figure><h3id="the-slave-io-thread-stops-because-master-and-slave-have-equal-mysql-server-uuids">Theslave I/O thread stops because master and slave have equal MySQL serverUUIDs</h3><p>这个问题通常是因为备份数据库时，把数据库的UUID也复制了下来。而主从关系要求这个UUID<strong>必须唯一</strong>。这个uuid通常存在<code>/var/log/mysql/auto.cnf</code>文件夹下，通常删除该文件，重启一下数据库即可。</p><p>PS：在开启<strong>GTID</strong>复制时，貌似不会自动复制auto.cnf此文件。</p><h2 id="引用">引用</h2><ul><li><p><a href="https://mp.weixin.qq.com/s/UzmWEnE13Fet1sxfuJm5Kg">MySQL基于GTID主从复制</a></p></li><li><p><ahref="https://mp.weixin.qq.com/s/g9M69oJwuMOUI3J-_QoFsQ">XtraBackup搭建从库的一般步骤及 XtraBackup 8.0 的注意事项</a></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文主要介绍如何使用StatefulSet搭建高可用的MySQL集群。&lt;/p&gt;
&lt;p&gt;关键词：&lt;strong&gt;k8s&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="k8s" scheme="https://fly97.cn/tags/k8s/"/>
    
  </entry>
  
</feed>
